from __future__ import annotations

import keyword
from collections.abc import Iterable
from pathlib import Path
from typing import ClassVar

from .constants import CODE_EXTENSIONS, DOC_EXTENSIONS

PY_KEYWORDS: frozenset[str] = frozenset(k.lower() for k in keyword.kwlist)

_CODE_STOPWORDS: frozenset[str] = frozenset(
    {
        # Common placeholders and comments
        "todo",
        "fixme",
        "note",
        "hack",
        "xxx",
        "foo",
        "bar",
        "baz",
        "qux",
        "tmp",
        "temp",
        # Python-specific
        "self",
        "cls",
        # Common method/function names (too generic for identifier matching)
        "get",
        "set",
        "add",
        "put",
        "delete",
        "remove",
        "update",
        "create",
        "read",
        "write",
        "open",
        "close",
        "start",
        "stop",
        "run",
        "execute",
        "call",
        "invoke",
        "handle",
        "process",
        "validate",
        "check",
        "test",
        "init",
        "setup",
        "teardown",
        "load",
        "save",
        "parse",
        "format",
        "convert",
        "transform",
        "render",
        "build",
        "make",
        "copy",
        "clone",
        "reset",
        "clear",
        "flush",
        "send",
        "receive",
        "emit",
        "dispatch",
        "notify",
        "subscribe",
        "publish",
        "connect",
        "disconnect",
        "bind",
        "listen",
        "accept",
        "sort",
        "filter",
        "find",
        "select",
        "insert",
        "append",
        "extend",
        "merge",
        "split",
        "join",
        "match",
        "replace",
        "trim",
        "strip",
        "contains",
        "includes",
        "push",
        "pop",
        "shift",
        "unshift",
        "concat",
        "slice",
        "splice",
        "reduce",
        "every",
        "some",
        "each",
        "print",
        "println",
        "printf",
        "sprintf",
        "fprintf",
        "throw",
        "catch",
        "abort",
        "retry",
        "apply",
        "resolve",
        "reject",
        "await",
        "async",
        "defer",
        "sleep",
        "wait",
        "poll",
        "encode",
        "decode",
        "encrypt",
        "decrypt",
        "hash",
        "sign",
        "verify",
        "register",
        "unregister",
        "mount",
        "unmount",
        "enable",
        "disable",
        "show",
        "hide",
        "lock",
        "unlock",
        "acquire",
        "release",
        "commit",
        "rollback",
        "begin",
        "end",
        # Common variable/parameter names
        "data",
        "value",
        "values",
        "result",
        "results",
        "item",
        "items",
        "element",
        "elements",
        "key",
        "keys",
        "name",
        "names",
        "text",
        "string",
        "str",
        "num",
        "number",
        "count",
        "index",
        "idx",
        "size",
        "length",
        "len",
        "list",
        "array",
        "map",
        "dict",
        "obj",
        "object",
        "args",
        "kwargs",
        "params",
        "options",
        "config",
        "settings",
        "context",
        "ctx",
        "state",
        "status",
        "type",
        "kind",
        "mode",
        "flag",
        "flags",
        "path",
        "file",
        "dir",
        "url",
        "uri",
        "host",
        "port",
        "input",
        "output",
        "source",
        "target",
        "dest",
        "src",
        "dst",
        "err",
        "error",
        "errors",
        "msg",
        "message",
        "messages",
        "log",
        "logger",
        "debug",
        "info",
        "warn",
        "warning",
        "func",
        "function",
        "method",
        "callback",
        "handler",
        "listener",
        "event",
        "events",
        "request",
        "response",
        "req",
        "res",
        "body",
        "header",
        "headers",
        "query",
        "param",
        "id",
        "uid",
        "uuid",
        "user",
        "users",
        "model",
        "models",
        "view",
        "views",
        "service",
        "services",
        "client",
        "server",
        "api",
        "app",
        "main",
        "util",
        "utils",
        "helper",
        "helpers",
        "common",
        "base",
        "core",
        "default",
        "defaults",
        "version",
        "label",
        "labels",
        "tag",
        "tags",
        "level",
        "scope",
        "token",
        "tokens",
        "task",
        "tasks",
        "job",
        "jobs",
        "step",
        "steps",
        "stage",
        "cache",
        "timeout",
        "interval",
        "duration",
        "timestamp",
        "channel",
        "buffer",
        "queue",
        "stack",
        "heap",
        "node",
        "nodes",
        "edge",
        "edges",
        "child",
        "children",
        "parent",
        "root",
        "leaf",
        "link",
        "ref",
        "reference",
        "instance",
        "schema",
        "table",
        "column",
        "row",
        "field",
        "record",
        "entry",
        "spec",
        "env",
        "namespace",
        "prefix",
        "suffix",
        "pattern",
        "template",
        "factory",
        "builder",
        "adapter",
        "proxy",
        "wrapper",
        "manager",
        "controller",
        "provider",
        "consumer",
        "producer",
        "worker",
        "pool",
        "connection",
        "session",
        "stream",
        "pipe",
        "socket",
        "signal",
        "trigger",
        "action",
        "command",
        "rule",
        "rules",
        "policy",
        "strategy",
        "middleware",
        "plugin",
        "module",
        "package",
        "component",
        "container",
        "registry",
        "repository",
        # Language keywords (not Python - those come from PY_KEYWORDS)
        "var",
        "let",
        "const",
        "new",
        "this",
        "null",
        "nil",
        "none",
        "void",
        "bool",
        "boolean",
        "true",
        "false",
        "int",
        "uint",
        "long",
        "float",
        "double",
        "char",
        "byte",
        "short",
        "signed",
        "unsigned",
        "static",
        "final",
        "abstract",
        "virtual",
        "override",
        "public",
        "private",
        "protected",
        "internal",
        "extern",
        "inline",
        "volatile",
        "mutable",
        "readonly",
        "super",
        "extends",
        "implements",
        "interface",
        "struct",
        "enum",
        "union",
        "trait",
        "impl",
        "class",
        "package",
        "import",
        "export",
        "require",
        "include",
        "using",
        "typedef",
        "define",
        "ifdef",
        "ifndef",
        "endif",
        "elif",
        "else",
        "case",
        "switch",
        "break",
        "continue",
        "return",
        "goto",
        "sizeof",
        "typeof",
        "instanceof",
        "throw",
        "throws",
        "try",
        "catch",
        "finally",
        "raise",
        "except",
        "yield",
        "lambda",
        "func",
        "proc",
        "sub",
        "def",
        # Shell builtins and scripting
        "echo",
        "done",
        "local",
        "eval",
        "exec",
        "exit",
        "trap",
        "bash",
        "then",
        "esac",
        "elif",
        "fi",
        "do",
        "for",
        "while",
        "until",
        "shift",
        "unset",
        "declare",
        "export",
        "alias",
        "which",
        "chmod",
        "chown",
        "mkdir",
        "rmdir",
        "curl",
        "wget",
        "grep",
        "sed",
        "awk",
        "xargs",
        "pipe",
        "stdin",
        "stdout",
        "stderr",
        "args",
        "argv",
        "argc",
        "envp",
        # JavaScript / Web / DOM
        "console",
        "document",
        "window",
        "navigator",
        "location",
        "history",
        "fetch",
        "promise",
        "undefined",
        "prototype",
        "constructor",
        "module",
        "exports",
        "require",
        "props",
        "children",
        "ref",
        "state",
        "effect",
        "memo",
        "style",
        "styles",
        "display",
        "margin",
        "padding",
        "border",
        "color",
        "width",
        "height",
        "flex",
        "grid",
        "onclick",
        "onchange",
        "onsubmit",
        "classname",
        "innerhtml",
        "textcontent",
        "appendchild",
        "createelement",
        "queryselector",
        "getelementbyid",
        "addeventlistener",
        # IaC / Terraform / Kubernetes / Cloud
        "resource",
        "variable",
        "output",
        "provider",
        "data",
        "locals",
        "terraform",
        "jsonencode",
        "cidr",
        "subnet",
        "ingress",
        "egress",
        "protocol",
        "cidr_blocks",
        "security_group",
        "arn",
        "vpc",
        "aws",
        "gcp",
        "azure",
        "region",
        "zone",
        "cluster",
        "replicas",
        "selector",
        "metadata",
        "annotations",
        "spec",
        "template",
        "volumes",
        "ports",
        "image",
        "containers",
        "resources",
        "limits",
        "requests",
        "apiversion",
        "kind",
        "namespace",
        "configmap",
        "secret",
        "deployment",
        "statefulset",
        "daemonset",
        "cronjob",
        "serviceaccount",
        "role",
        "rolebinding",
        "clusterrole",
        # CI/CD
        "install",
        "deploy",
        "pipeline",
        "script",
        "image",
        "pull",
        "push",
        "uses",
        "with",
        "needs",
        "runs",
        "checkout",
        "artifact",
        "artifacts",
        "workflow",
        "trigger",
        "schedule",
        "cron",
        "branch",
        "branches",
        "tags",
        "release",
        "publish",
        # Docker
        "from",
        "copy",
        "workdir",
        "expose",
        "entrypoint",
        "volume",
        "arg",
        "label",
        "healthcheck",
        "shell",
        "user",
        "stopsignal",
        # Testing
        "describe",
        "it",
        "expect",
        "assert",
        "should",
        "mock",
        "stub",
        "spy",
        "before",
        "after",
        "beforeall",
        "afterall",
        "beforeeach",
        "aftereach",
        "suite",
        "fixture",
        "given",
        "when",
        "spec",
        # OOP / Design patterns
        "abstract",
        "interface",
        "override",
        "implement",
        "inherit",
        "extends",
        "mixin",
        "trait",
        "self",
        "this",
        "super",
        "new",
        "create",
        "destroy",
        "dispose",
        "finalize",
        "toString",
        "tostring",
        "hashcode",
        "equals",
        # SQL / Database
        "select",
        "insert",
        "update",
        "delete",
        "from",
        "where",
        "join",
        "inner",
        "outer",
        "left",
        "right",
        "group",
        "order",
        "limit",
        "offset",
        "having",
        "distinct",
        "count",
        "sum",
        "avg",
        "min",
        "max",
        "table",
        "column",
        "index",
        "constraint",
        "primary",
        "foreign",
        "unique",
        "null",
        "not",
        "and",
        "or",
        "like",
        "between",
        "exists",
        "values",
        "into",
        "alter",
        "drop",
        "truncate",
        "grant",
        "revoke",
        # Markup / Config
        "html",
        "head",
        "body",
        "title",
        "meta",
        "link",
        "script",
        "div",
        "span",
        "form",
        "button",
        "label",
        "input",
        "select",
        "option",
        "table",
        "thead",
        "tbody",
        "img",
        "href",
        "class",
        "style",
        "type",
        "name",
        "value",
        "placeholder",
        "required",
        "disabled",
        "checked",
        "selected",
        "hidden",
        "readonly",
        # Networking / HTTP
        "http",
        "https",
        "tcp",
        "udp",
        "dns",
        "ssl",
        "tls",
        "cert",
        "certificate",
        "content",
        "accept",
        "authorization",
        "bearer",
        "basic",
        "digest",
        "origin",
        "referer",
        "cookie",
        "cookies",
        "redirect",
        "proxy",
        "gateway",
        "load",
        "balance",
        "upstream",
        "downstream",
        "endpoint",
        "route",
        "routes",
        "router",
        "method",
        "status",
        "code",
        # Language names and runtime identifiers
        "java",
        "python",
        "golang",
        "ruby",
        "rust",
        "swift",
        "kotlin",
        "scala",
        "perl",
        "elixir",
        "haskell",
        "clojure",
        "erlang",
        "typescript",
        "javascript",
        "csharp",
        "cplusplus",
        "alpine",
        "ubuntu",
        "debian",
        "linux",
        "darwin",
        "windows",
        # Standard library / type names (too generic)
        "time",
        "math",
        "system",
        "vector",
        "hashmap",
        "hashset",
        "treemap",
        "arraylist",
        "linkedlist",
        "optional",
        "future",
        "pair",
        "tuple",
        "collection",
        "collections",
        "iterator",
        "iterable",
        "comparable",
        "serializable",
        "cloneable",
        "runnable",
        "callable",
        "supplier",
        "predicate",
        "consumer",
        "comparator",
        "json",
        "xml",
        "yaml",
        "toml",
        "csv",
        "size_t",
        "usize",
        "isize",
        "int8",
        "int16",
        "int32",
        "int64",
        "uint8",
        "uint16",
        "uint32",
        "uint64",
        "float32",
        "float64",
        "string",
        "boolean",
        "bool",
        "true",
        "false",
        "null",
        "none",
        "undefined",
        # Python dunder / common methods
        "__init__",
        "__main__",
        "__name__",
        "__str__",
        "__repr__",
        "__eq__",
        "__hash__",
        "__len__",
        "__iter__",
        "__next__",
        "__enter__",
        "__exit__",
        "to_string",
        "tostring",
        "hashcode",
        "equals",
        "valueof",
        "getclass",
        # Common domain terms (too generic for identifier matching)
        "email",
        "phone",
        "address",
        "date",
        "datetime",
        "timestamp",
        "password",
        "username",
        "token",
        "session",
        "auth",
        "login",
        "logout",
        "admin",
        "account",
        "profile",
        "role",
        "permission",
        "group",
        "team",
        "organization",
        "project",
        "title",
        "description",
        "content",
        "category",
        "tags",
        "comment",
        "comments",
        "like",
        "share",
        "search",
        "page",
        "pages",
        "image",
        "file",
        "upload",
        "download",
        "notification",
        "notifications",
        "alert",
        "alerts",
        "validation",
        "production",
        "staging",
        "development",
        "testing",
        "localhost",
        "unknown",
        "refs",
        "heads",
        "origin",
        "remote",
        "upstream",
        "master",
        "branch",
        "merge",
        "rebase",
        "cherry",
        "stash",
    }
)

CODE_STOPWORDS: frozenset[str] = _CODE_STOPWORDS | PY_KEYWORDS


class TokenProfile:
    CODE = "code"
    DOCS = "docs"
    LEGAL = "legal"
    DATA = "data"
    GENERIC = "generic"

    _PROFILES: ClassVar[dict[str, tuple[frozenset[str], int]]] = {
        CODE: (CODE_STOPWORDS, 3),
        DOCS: (frozenset(), 3),
        LEGAL: (frozenset(), 4),
        DATA: (frozenset(), 2),
        GENERIC: (CODE_STOPWORDS, 3),
    }

    @classmethod
    def get_stopwords(cls, profile: str) -> frozenset[str]:
        return cls._PROFILES.get(profile, cls._PROFILES[cls.GENERIC])[0]

    @classmethod
    def get_min_len(cls, profile: str) -> int:
        return cls._PROFILES.get(profile, cls._PROFILES[cls.GENERIC])[1]

    @classmethod
    def from_path(cls, path_str: str) -> str:
        p = Path(path_str)
        suffix = p.suffix.lower()
        name_lower = p.name.lower()

        if suffix in CODE_EXTENSIONS:
            return cls.CODE

        if suffix in DOC_EXTENSIONS or suffix in {".markdown", ".tex"}:
            return cls.DOCS

        data_exts = {".csv", ".json", ".jsonl", ".yaml", ".yml", ".toml", ".xml", ".ini", ".env"}
        if suffix in data_exts:
            return cls.DATA

        legal_names = {"license", "licence", "legal", "terms", "agreement", "contract", "policy", "privacy", "tos", "eula"}
        stem = p.stem.lower()
        if stem in legal_names or any(lw in name_lower for lw in ("license", "legal", "terms")):
            return cls.LEGAL

        return cls.GENERIC


def is_reasonable_ident(ident: str, *, min_len: int = 3, profile: str = "code") -> bool:
    if not ident or len(ident) < min_len:
        return False
    low = ident.lower()
    stopwords = TokenProfile.get_stopwords(profile)
    if low in stopwords:
        return False
    if low.isdigit():
        return False
    return True


def filter_idents(idents: Iterable[str], *, min_len: int = 3, profile: str = "code") -> list[str]:
    return [s for s in idents if is_reasonable_ident(s, min_len=min_len, profile=profile)]
