name: java_021_builder_pattern
initial:
  src/main/java/com/orderapi/dto/OrderRequest.java: |
    package com.orderapi.dto;

    import java.math.BigDecimal;
    import java.time.LocalDateTime;
    import java.util.ArrayList;
    import java.util.List;

    public class OrderRequest {
        private final String customerId;
        private final String customerEmail;
        private final List<OrderItemRequest> items;
        private final String shippingMethod;
        private final BigDecimal discount;

        public OrderRequest(String customerId, String customerEmail, List<OrderItemRequest> items,
                           String shippingMethod, BigDecimal discount) {
            this.customerId = customerId;
            this.customerEmail = customerEmail;
            this.items = items != null ? new ArrayList<>(items) : new ArrayList<>();
            this.shippingMethod = shippingMethod;
            this.discount = discount;
        }

        public String getCustomerId() { return customerId; }
        public String getCustomerEmail() { return customerEmail; }
        public List<OrderItemRequest> getItems() { return new ArrayList<>(items); }
        public String getShippingMethod() { return shippingMethod; }
        public BigDecimal getDiscount() { return discount; }
    }
  src/main/java/com/orderapi/dto/OrderItemRequest.java: |
    package com.orderapi.dto;

    import java.math.BigDecimal;

    public class OrderItemRequest {
        private final String productId;
        private final String productName;
        private final int quantity;
        private final BigDecimal unitPrice;

        public OrderItemRequest(String productId, String productName, int quantity, BigDecimal unitPrice) {
            this.productId = productId;
            this.productName = productName;
            this.quantity = quantity;
            this.unitPrice = unitPrice;
        }

        public String getProductId() { return productId; }
        public String getProductName() { return productName; }
        public int getQuantity() { return quantity; }
        public BigDecimal getUnitPrice() { return unitPrice; }

        public BigDecimal getSubtotal() {
            return unitPrice.multiply(BigDecimal.valueOf(quantity));
        }
    }
  src/main/java/com/orderapi/service/OrderService.java: |
    package com.orderapi.service;

    import com.orderapi.dto.OrderRequest;
    import org.springframework.stereotype.Service;

    @Service
    public class OrderService {
        public String createOrder(OrderRequest request) {
            return "ORD-" + System.currentTimeMillis();
        }
    }
  src/main/java/com/orderapi/unrelated/CacheWarmerService.java: |
    package com.orderapi.unrelated;

    import org.springframework.scheduling.annotation.Scheduled;
    import org.springframework.stereotype.Service;
    import java.util.concurrent.ConcurrentHashMap;
    import java.util.concurrent.atomic.AtomicInteger;

    @Service
    public class CacheWarmerService {
        public static final String GARBAGE_JAVA_CACHE_B021A = "cache_warmer_marker_alpha";
        private static final String GARBAGE_JAVA_WARM_B021B = "warm_cycle_marker_beta";

        private final ConcurrentHashMap<String, Object> cacheStore = new ConcurrentHashMap<>();
        private final AtomicInteger warmCycleCount = new AtomicInteger(0);

        @Scheduled(fixedRate = 300000)
        public void warmProductCache() {
            int cycle = warmCycleCount.incrementAndGet();
            logGarbageMarkers(cycle);
            cacheStore.put("products_warmed_at", System.currentTimeMillis());
        }

        @Scheduled(fixedRate = 600000)
        public void warmUserCache() {
            cacheStore.put("users_warmed_at", System.currentTimeMillis());
            String GARBAGE_JAVA_USER_B021C = "user_cache_marker_gamma";
            System.out.println(GARBAGE_JAVA_USER_B021C);
        }

        public void invalidateCache(String key) {
            cacheStore.remove(key);
        }

        private void logGarbageMarkers(int cycle) {
            System.out.println(GARBAGE_JAVA_CACHE_B021A + " cycle=" + cycle);
            System.out.println(GARBAGE_JAVA_WARM_B021B);
        }
    }
  src/main/java/com/orderapi/unrelated/FeatureFlagService.java: |
    package com.orderapi.unrelated;

    import org.springframework.stereotype.Service;
    import java.util.HashMap;
    import java.util.Map;
    import java.util.Set;

    @Service
    public class FeatureFlagService {
        public static final String GARBAGE_JAVA_FLAG_B021D = "feature_flag_marker_delta";
        private static final String GARBAGE_JAVA_TOGGLE_B021E = "toggle_state_marker_epsilon";

        private final Map<String, Boolean> flags = new HashMap<>();
        private final Map<String, Set<String>> userOverrides = new HashMap<>();

        public boolean isEnabled(String flagName) {
            logGarbageMarkers();
            return flags.getOrDefault(flagName, false);
        }

        public boolean isEnabledForUser(String flagName, String userId) {
            Set<String> overrides = userOverrides.get(flagName);
            if (overrides != null && overrides.contains(userId)) {
                return true;
            }
            return isEnabled(flagName);
        }

        public void setFlag(String flagName, boolean enabled) {
            flags.put(flagName, enabled);
        }

        public void addUserOverride(String flagName, String userId) {
            userOverrides.computeIfAbsent(flagName, k -> new java.util.HashSet<>()).add(userId);
        }

        private void logGarbageMarkers() {
            System.out.println(GARBAGE_JAVA_FLAG_B021D + GARBAGE_JAVA_TOGGLE_B021E);
        }
    }
  src/main/java/com/orderapi/unrelated/RateLimiterService.java: |
    package com.orderapi.unrelated;

    import org.springframework.stereotype.Service;
    import java.time.Instant;
    import java.util.concurrent.ConcurrentHashMap;

    @Service
    public class RateLimiterService {
        public static final String GARBAGE_JAVA_RATE_B021F = "rate_limiter_marker_zeta";

        private final ConcurrentHashMap<String, TokenBucket> buckets = new ConcurrentHashMap<>();
        private final int maxTokens;
        private final int refillRate;

        public RateLimiterService() {
            this.maxTokens = 100;
            this.refillRate = 10;
        }

        public boolean tryAcquire(String clientId) {
            TokenBucket bucket = buckets.computeIfAbsent(clientId,
                k -> new TokenBucket(maxTokens, refillRate));
            String GARBAGE_JAVA_ACQUIRE_B021G = "acquire_attempt_marker_eta";
            System.out.println(GARBAGE_JAVA_RATE_B021F + GARBAGE_JAVA_ACQUIRE_B021G);
            return bucket.tryConsume();
        }

        private static class TokenBucket {
            private int tokens;
            private final int maxTokens;
            private final int refillRate;
            private Instant lastRefill;

            TokenBucket(int maxTokens, int refillRate) {
                this.tokens = maxTokens;
                this.maxTokens = maxTokens;
                this.refillRate = refillRate;
                this.lastRefill = Instant.now();
            }

            synchronized boolean tryConsume() {
                refill();
                if (tokens > 0) {
                    tokens--;
                    return true;
                }
                return false;
            }

            private void refill() {
                Instant now = Instant.now();
                long elapsed = now.toEpochMilli() - lastRefill.toEpochMilli();
                int tokensToAdd = (int) (elapsed / 1000) * refillRate;
                tokens = Math.min(maxTokens, tokens + tokensToAdd);
                lastRefill = now;
            }
        }
    }
changed:
  src/main/java/com/orderapi/dto/OrderRequest.java: |
    package com.orderapi.dto;

    import java.math.BigDecimal;
    import java.time.LocalDateTime;
    import java.util.ArrayList;
    import java.util.Collections;
    import java.util.List;
    import java.util.Objects;
    import java.util.UUID;

    public class OrderRequest {
        private final String orderId;
        private final String customerId;
        private final String customerEmail;
        private final String customerPhone;
        private final List<OrderItemRequest> items;
        private final ShippingInfo shippingInfo;
        private final BillingInfo billingInfo;
        private final String shippingMethod;
        private final BigDecimal discount;
        private final String discountCode;
        private final String notes;
        private final boolean giftOrder;
        private final String giftMessage;
        private final LocalDateTime requestedDeliveryDate;
        private final PaymentMethod paymentMethod;
        private final String currencyCode;

        private OrderRequest(Builder builder) {
            this.orderId = builder.orderId != null ? builder.orderId : UUID.randomUUID().toString();
            this.customerId = Objects.requireNonNull(builder.customerId, "customerId is required");
            this.customerEmail = Objects.requireNonNull(builder.customerEmail, "customerEmail is required");
            this.customerPhone = builder.customerPhone;
            this.items = builder.items != null ? new ArrayList<>(builder.items) : new ArrayList<>();
            this.shippingInfo = builder.shippingInfo;
            this.billingInfo = builder.billingInfo;
            this.shippingMethod = builder.shippingMethod != null ? builder.shippingMethod : "STANDARD";
            this.discount = builder.discount != null ? builder.discount : BigDecimal.ZERO;
            this.discountCode = builder.discountCode;
            this.notes = builder.notes;
            this.giftOrder = builder.giftOrder;
            this.giftMessage = builder.giftMessage;
            this.requestedDeliveryDate = builder.requestedDeliveryDate;
            this.paymentMethod = builder.paymentMethod != null ? builder.paymentMethod : PaymentMethod.CREDIT_CARD;
            this.currencyCode = builder.currencyCode != null ? builder.currencyCode : "USD";
        }

        public static Builder builder() {
            return new Builder();
        }

        public String getOrderId() { return orderId; }
        public String getCustomerId() { return customerId; }
        public String getCustomerEmail() { return customerEmail; }
        public String getCustomerPhone() { return customerPhone; }
        public List<OrderItemRequest> getItems() { return Collections.unmodifiableList(items); }
        public ShippingInfo getShippingInfo() { return shippingInfo; }
        public BillingInfo getBillingInfo() { return billingInfo; }
        public String getShippingMethod() { return shippingMethod; }
        public BigDecimal getDiscount() { return discount; }
        public String getDiscountCode() { return discountCode; }
        public String getNotes() { return notes; }
        public boolean isGiftOrder() { return giftOrder; }
        public String getGiftMessage() { return giftMessage; }
        public LocalDateTime getRequestedDeliveryDate() { return requestedDeliveryDate; }
        public PaymentMethod getPaymentMethod() { return paymentMethod; }
        public String getCurrencyCode() { return currencyCode; }

        public BigDecimal calculateSubtotal() {
            return items.stream()
                .map(OrderItemRequest::getSubtotal)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        }

        public BigDecimal calculateTotal() {
            BigDecimal subtotal = calculateSubtotal();
            return subtotal.subtract(discount).max(BigDecimal.ZERO);
        }

        public int getTotalItemCount() {
            return items.stream().mapToInt(OrderItemRequest::getQuantity).sum();
        }

        public boolean hasItems() {
            return !items.isEmpty();
        }

        public Builder toBuilder() {
            return new Builder()
                .orderId(this.orderId)
                .customerId(this.customerId)
                .customerEmail(this.customerEmail)
                .customerPhone(this.customerPhone)
                .items(new ArrayList<>(this.items))
                .shippingInfo(this.shippingInfo)
                .billingInfo(this.billingInfo)
                .shippingMethod(this.shippingMethod)
                .discount(this.discount)
                .discountCode(this.discountCode)
                .notes(this.notes)
                .giftOrder(this.giftOrder)
                .giftMessage(this.giftMessage)
                .requestedDeliveryDate(this.requestedDeliveryDate)
                .paymentMethod(this.paymentMethod)
                .currencyCode(this.currencyCode);
        }

        public static class Builder {
            private String orderId;
            private String customerId;
            private String customerEmail;
            private String customerPhone;
            private List<OrderItemRequest> items = new ArrayList<>();
            private ShippingInfo shippingInfo;
            private BillingInfo billingInfo;
            private String shippingMethod;
            private BigDecimal discount;
            private String discountCode;
            private String notes;
            private boolean giftOrder;
            private String giftMessage;
            private LocalDateTime requestedDeliveryDate;
            private PaymentMethod paymentMethod;
            private String currencyCode;

            public Builder orderId(String orderId) {
                this.orderId = orderId;
                return this;
            }

            public Builder customerId(String customerId) {
                this.customerId = customerId;
                return this;
            }

            public Builder customerEmail(String customerEmail) {
                this.customerEmail = customerEmail;
                return this;
            }

            public Builder customerPhone(String customerPhone) {
                this.customerPhone = customerPhone;
                return this;
            }

            public Builder items(List<OrderItemRequest> items) {
                this.items = items != null ? new ArrayList<>(items) : new ArrayList<>();
                return this;
            }

            public Builder addItem(OrderItemRequest item) {
                if (item != null) {
                    this.items.add(item);
                }
                return this;
            }

            public Builder shippingInfo(ShippingInfo shippingInfo) {
                this.shippingInfo = shippingInfo;
                return this;
            }

            public Builder billingInfo(BillingInfo billingInfo) {
                this.billingInfo = billingInfo;
                return this;
            }

            public Builder shippingMethod(String shippingMethod) {
                this.shippingMethod = shippingMethod;
                return this;
            }

            public Builder discount(BigDecimal discount) {
                this.discount = discount;
                return this;
            }

            public Builder discountCode(String discountCode) {
                this.discountCode = discountCode;
                return this;
            }

            public Builder notes(String notes) {
                this.notes = notes;
                return this;
            }

            public Builder giftOrder(boolean giftOrder) {
                this.giftOrder = giftOrder;
                return this;
            }

            public Builder giftMessage(String giftMessage) {
                this.giftMessage = giftMessage;
                return this;
            }

            public Builder requestedDeliveryDate(LocalDateTime requestedDeliveryDate) {
                this.requestedDeliveryDate = requestedDeliveryDate;
                return this;
            }

            public Builder paymentMethod(PaymentMethod paymentMethod) {
                this.paymentMethod = paymentMethod;
                return this;
            }

            public Builder currencyCode(String currencyCode) {
                this.currencyCode = currencyCode;
                return this;
            }

            public OrderRequest build() {
                return new OrderRequest(this);
            }
        }
    }
  src/main/java/com/orderapi/dto/ShippingInfo.java: |
    package com.orderapi.dto;

    public record ShippingInfo(
        String recipientName,
        String addressLine1,
        String addressLine2,
        String city,
        String state,
        String postalCode,
        String country,
        String phoneNumber,
        String deliveryInstructions
    ) {
        public String getFullAddress() {
            StringBuilder sb = new StringBuilder();
            sb.append(addressLine1);
            if (addressLine2 != null && !addressLine2.isBlank()) {
                sb.append(", ").append(addressLine2);
            }
            sb.append(", ").append(city);
            sb.append(", ").append(state);
            sb.append(" ").append(postalCode);
            sb.append(", ").append(country);
            return sb.toString();
        }
    }
  src/main/java/com/orderapi/dto/BillingInfo.java: |
    package com.orderapi.dto;

    public record BillingInfo(
        String cardholderName,
        String addressLine1,
        String city,
        String state,
        String postalCode,
        String country
    ) {}
  src/main/java/com/orderapi/dto/PaymentMethod.java: |
    package com.orderapi.dto;

    public enum PaymentMethod {
        CREDIT_CARD,
        DEBIT_CARD,
        PAYPAL,
        BANK_TRANSFER,
        APPLE_PAY,
        GOOGLE_PAY
    }
assertions:
  must_include:
    - Builder
    - builder()
    - build()
    - toBuilder()
    - addItem
    - ShippingInfo
    - BillingInfo
    - PaymentMethod
    - calculateSubtotal
    - calculateTotal
    - giftOrder
    - requestedDeliveryDate
    - currencyCode
  must_not_include:
    - GARBAGE_JAVA_CACHE_B021A
    - GARBAGE_JAVA_WARM_B021B
    - GARBAGE_JAVA_USER_B021C
    - GARBAGE_JAVA_FLAG_B021D
    - GARBAGE_JAVA_TOGGLE_B021E
    - GARBAGE_JAVA_RATE_B021F
    - GARBAGE_JAVA_ACQUIRE_B021G
    - CacheWarmerService
    - FeatureFlagService
    - RateLimiterService
    - warmProductCache
    - warmUserCache
    - isEnabledForUser
    - tryAcquire
    - TokenBucket
options:
  commit_message: Add comprehensive builder pattern with shipping, billing, and payment support
