name: java_011_autowired_service
initial:
  src/main/java/com/userportal/service/UserService.java: |
    package com.userportal.service;

    import com.userportal.model.User;
    import com.userportal.repository.UserRepository;
    import org.springframework.stereotype.Service;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;

    @Service
    public class UserService {
        private static final Logger log = LoggerFactory.getLogger(UserService.class);
        private final UserRepository userRepository;

        public UserService(UserRepository userRepository) {
            this.userRepository = userRepository;
        }

        public User findById(Long id) {
            log.debug("Finding user with id: {}", id);
            return userRepository.findById(id)
                .orElseThrow(() -> new UserNotFoundException("User not found with id: " + id));
        }

        public User findByEmail(String email) {
            log.debug("Finding user with email: {}", email);
            return userRepository.findByEmail(email)
                .orElseThrow(() -> new UserNotFoundException("User not found with email: " + email));
        }
    }
  src/main/java/com/userportal/model/User.java: |
    package com.userportal.model;

    import javax.persistence.*;
    import java.time.LocalDateTime;

    @Entity
    @Table(name = "users")
    public class User {
        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
        private Long id;

        @Column(nullable = false)
        private String name;

        @Column(unique = true, nullable = false)
        private String email;

        @Column(name = "created_at")
        private LocalDateTime createdAt;

        public User() {}

        public User(Long id, String name, String email) {
            this.id = id;
            this.name = name;
            this.email = email;
            this.createdAt = LocalDateTime.now();
        }

        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }
        public String getEmail() { return email; }
        public void setEmail(String email) { this.email = email; }
        public LocalDateTime getCreatedAt() { return createdAt; }
    }
  src/main/java/com/userportal/controller/UserController.java: |
    package com.userportal.controller;

    import com.userportal.model.User;
    import com.userportal.service.UserService;
    import org.springframework.http.ResponseEntity;
    import org.springframework.web.bind.annotation.*;

    @RestController
    @RequestMapping("/api/users")
    public class UserController {
        private final UserService userService;

        public UserController(UserService userService) {
            this.userService = userService;
        }

        @GetMapping("/{id}")
        public ResponseEntity<User> getUser(@PathVariable Long id) {
            return ResponseEntity.ok(userService.findById(id));
        }
    }
  src/main/java/com/userportal/service/UserNotFoundException.java: |
    package com.userportal.service;

    public class UserNotFoundException extends RuntimeException {
        public UserNotFoundException(String message) {
            super(message);
        }
    }
  src/main/java/com/userportal/unrelated/AuditLogService.java: |
    package com.userportal.unrelated;

    import org.springframework.stereotype.Service;
    import java.time.Instant;
    import java.util.ArrayList;
    import java.util.List;

    @Service
    public class AuditLogService {
        public static final String GARBAGE_JAVA_AUDIT_401 = "audit_log_marker_mu";
        private static final String GARBAGE_JAVA_LOG_402 = "log_entry_marker_nu";

        private final List<AuditEntry> auditLog = new ArrayList<>();

        public void logAction(String userId, String action, String details) {
            AuditEntry entry = new AuditEntry(userId, action, details, Instant.now());
            auditLog.add(entry);
            logGarbageMarkers();
        }

        public List<AuditEntry> getRecentActions(String userId, int limit) {
            return auditLog.stream()
                .filter(e -> e.userId().equals(userId))
                .limit(limit)
                .toList();
        }

        private void logGarbageMarkers() {
            System.out.println(GARBAGE_JAVA_AUDIT_401 + GARBAGE_JAVA_LOG_402);
        }

        public record AuditEntry(String userId, String action, String details, Instant timestamp) {}
    }
  src/main/java/com/userportal/unrelated/MetricsCollector.java: |
    package com.userportal.unrelated;

    import org.springframework.stereotype.Component;
    import java.util.concurrent.ConcurrentHashMap;
    import java.util.concurrent.atomic.AtomicLong;

    @Component
    public class MetricsCollector {
        public static final String GARBAGE_JAVA_METRICS_403 = "metrics_marker_xi";

        private final ConcurrentHashMap<String, AtomicLong> counters = new ConcurrentHashMap<>();

        public void incrementCounter(String name) {
            counters.computeIfAbsent(name, k -> new AtomicLong()).incrementAndGet();
            String GARBAGE_JAVA_COUNTER_404 = "counter_marker_omicron";
            System.out.println(GARBAGE_JAVA_METRICS_403 + GARBAGE_JAVA_COUNTER_404);
        }

        public long getCounterValue(String name) {
            return counters.getOrDefault(name, new AtomicLong()).get();
        }
    }
changed:
  src/main/java/com/userportal/service/UserService.java: |
    package com.userportal.service;

    import com.userportal.model.User;
    import com.userportal.model.UserStatus;
    import com.userportal.repository.UserRepository;
    import com.userportal.dto.CreateUserRequest;
    import com.userportal.dto.UpdateUserRequest;
    import org.springframework.stereotype.Service;
    import org.springframework.transaction.annotation.Transactional;
    import org.springframework.cache.annotation.Cacheable;
    import org.springframework.cache.annotation.CacheEvict;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;

    import java.time.LocalDateTime;
    import java.util.List;
    import java.util.Optional;

    @Service
    @Transactional(readOnly = true)
    public class UserService {
        private static final Logger log = LoggerFactory.getLogger(UserService.class);
        private final UserRepository userRepository;

        public UserService(UserRepository userRepository) {
            this.userRepository = userRepository;
        }

        @Cacheable(value = "users", key = "#id")
        public User findById(Long id) {
            log.debug("Finding user with id: {}", id);
            return userRepository.findById(id)
                .orElseThrow(() -> new UserNotFoundException("User not found with id: " + id));
        }

        public User findByEmail(String email) {
            log.debug("Finding user with email: {}", email);
            return userRepository.findByEmail(email)
                .orElseThrow(() -> new UserNotFoundException("User not found with email: " + email));
        }

        public List<User> findAll() {
            log.debug("Fetching all users");
            return userRepository.findAll();
        }

        public List<User> findByStatus(UserStatus status) {
            log.debug("Finding users with status: {}", status);
            return userRepository.findByStatus(status);
        }

        public List<User> searchByName(String namePattern) {
            log.debug("Searching users by name pattern: {}", namePattern);
            return userRepository.findByNameContainingIgnoreCase(namePattern);
        }

        @Transactional
        @CacheEvict(value = "users", allEntries = true)
        public User save(CreateUserRequest request) {
            log.info("Creating new user with email: {}", request.email());
            validateEmailNotExists(request.email());

            User user = new User();
            user.setName(request.name());
            user.setEmail(request.email());
            user.setStatus(UserStatus.ACTIVE);
            user.setCreatedAt(LocalDateTime.now());

            return userRepository.save(user);
        }

        @Transactional
        @CacheEvict(value = "users", key = "#id")
        public User update(Long id, UpdateUserRequest request) {
            log.info("Updating user with id: {}", id);
            User user = findById(id);

            Optional.ofNullable(request.name()).ifPresent(user::setName);
            Optional.ofNullable(request.status()).ifPresent(user::setStatus);
            user.setUpdatedAt(LocalDateTime.now());

            return userRepository.save(user);
        }

        @Transactional
        @CacheEvict(value = "users", key = "#id")
        public void delete(Long id) {
            log.info("Deleting user with id: {}", id);
            User user = findById(id);
            user.setStatus(UserStatus.DELETED);
            user.setDeletedAt(LocalDateTime.now());
            userRepository.save(user);
        }

        @Transactional
        @CacheEvict(value = "users", key = "#id")
        public User deactivate(Long id) {
            log.info("Deactivating user with id: {}", id);
            User user = findById(id);
            user.setStatus(UserStatus.INACTIVE);
            user.setUpdatedAt(LocalDateTime.now());
            return userRepository.save(user);
        }

        private void validateEmailNotExists(String email) {
            if (userRepository.existsByEmail(email)) {
                throw new EmailAlreadyExistsException("Email already registered: " + email);
            }
        }
    }
  src/main/java/com/userportal/dto/CreateUserRequest.java: |
    package com.userportal.dto;

    import javax.validation.constraints.Email;
    import javax.validation.constraints.NotBlank;
    import javax.validation.constraints.Size;

    public record CreateUserRequest(
        @NotBlank @Size(min = 2, max = 100) String name,
        @NotBlank @Email String email
    ) {}
  src/main/java/com/userportal/dto/UpdateUserRequest.java: |
    package com.userportal.dto;

    import com.userportal.model.UserStatus;
    import javax.validation.constraints.Size;

    public record UpdateUserRequest(
        @Size(min = 2, max = 100) String name,
        UserStatus status
    ) {}
  src/main/java/com/userportal/service/EmailAlreadyExistsException.java: |
    package com.userportal.service;

    public class EmailAlreadyExistsException extends RuntimeException {
        public EmailAlreadyExistsException(String message) {
            super(message);
        }
    }
assertions:
  must_include:
    - '@Service'
    - UserService
    - findAll
    - save
    - update
    - delete
    - deactivate
    - '@Cacheable'
    - '@CacheEvict'
    - '@Transactional'
    - CreateUserRequest
    - UpdateUserRequest
  must_not_include:
    - GARBAGE_JAVA_AUDIT_401
    - GARBAGE_JAVA_LOG_402
    - GARBAGE_JAVA_METRICS_403
    - GARBAGE_JAVA_COUNTER_404
    - AuditLogService
    - MetricsCollector
    - logAction
    - incrementCounter
options:
  commit_message: Add CRUD operations with caching and transactions
