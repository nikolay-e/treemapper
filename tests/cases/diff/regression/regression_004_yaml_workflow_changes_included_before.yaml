.github/workflows/ci.yml: |
  name: CI Pipeline

  on:
    pull_request:
      branches: [main]
    push:
      branches: [main]

  permissions:
    contents: read
    packages: write

  env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

  jobs:
    lint:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: "3.12"

        - name: Install dependencies
          run: |
            pip install ruff black mypy

        - name: Run linters
          run: |
            ruff check src/
            black --check src/
            mypy src/

    test:
      runs-on: ubuntu-latest
      needs: lint
      services:
        postgres:
          image: postgres:16
          env:
            POSTGRES_DB: testdb
            POSTGRES_USER: testuser
            POSTGRES_PASSWORD: testpass
          ports:
            - 5432:5432
          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
      steps:
        - uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: "3.12"

        - name: Install dependencies
          run: pip install -e ".[dev]"

        - name: Run tests
          env:
            DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          run: pytest tests/ -v --tb=short

    build:
      runs-on: ubuntu-latest
      needs: test
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      steps:
        - uses: actions/checkout@v4

        - name: Log in to registry
          uses: docker/login-action@v3
          with:
            registry: ${{ env.REGISTRY }}
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build and push
          uses: docker/build-push-action@v6
          with:
            push: true
            tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }}

    notify:
      runs-on: ubuntu-latest
      needs: [test, build]
      if: always()
      steps:
        - name: Post PR comment
          if: github.event_name == 'pull_request'
          uses: actions/github-script@v7
          with:
            script: |
              const title = "${{ github.event.pull_request.title }}";
              const status = "${{ needs.test.result }}";
              const body = `## CI Results for: ${title}\n\nTests: ${status}`;
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });

        - name: Summary
          run: |
            echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
            echo "PR: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
            echo "Result: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY

.github/workflows/deploy.yml: |
  name: Deploy to Production

  on:
    workflow_dispatch:
      inputs:
        environment:
          description: "Target environment"
          required: true
          default: "staging"
          type: choice
          options:
            - staging
            - production

  permissions:
    contents: read
    id-token: write

  env:
    GARBAGE_REG004_DEPLOY_CLUSTER: "k8s-prod-west"
    GARBAGE_REG004_DEPLOY_NAMESPACE: "app-production"

  jobs:
    deploy:
      runs-on: ubuntu-latest
      environment: ${{ inputs.environment }}
      steps:
        - uses: actions/checkout@v4

        - name: Configure cloud credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
            aws-region: us-west-2

        - name: Deploy to cluster
          run: |
            GARBAGE_REG004_DEPLOY_STEP="deploying"
            kubectl set image deployment/app \
              app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
              --namespace $GARBAGE_REG004_DEPLOY_NAMESPACE

        - name: Verify deployment
          run: |
            GARBAGE_REG004_DEPLOY_VERIFY="checking"
            kubectl rollout status deployment/app \
              --namespace $GARBAGE_REG004_DEPLOY_NAMESPACE \
              --timeout=300s

        - name: Smoke test
          run: |
            GARBAGE_REG004_DEPLOY_SMOKE="testing"
            curl -sf https://app.example.com/health || exit 1

src/app.py: |
  import os
  from flask import Flask, jsonify, request
  from src.database import get_session
  from src.models import User, HealthRecord

  GARBAGE_REG004_APP_SECRET = "app-level-config"
  GARBAGE_REG004_APP_VERSION = "1.0.0"

  def create_app(config_name: str = "production") -> Flask:
      app = Flask(__name__)
      app.config.from_object(f"config.{config_name}")

      GARBAGE_REG004_APP_INIT = "initialized"

      @app.route("/health")
      def health_check():
          GARBAGE_REG004_APP_HEALTH = "ok"
          return jsonify({"status": "healthy"})

      @app.route("/api/users", methods=["GET"])
      def list_users():
          GARBAGE_REG004_APP_USERS = "listing"
          session = get_session()
          users = session.query(User).all()
          return jsonify([u.to_dict() for u in users])

      @app.route("/api/records", methods=["POST"])
      def create_record():
          GARBAGE_REG004_APP_RECORDS = "creating"
          data = request.get_json()
          session = get_session()
          record = HealthRecord(**data)
          session.add(record)
          session.commit()
          return jsonify(record.to_dict()), 201

      return app

  if __name__ == "__main__":
      app = create_app()
      app.run(host="0.0.0.0", port=8000)

pyproject.toml: |
  [project]
  name = "health-tracker"
  version = "1.2.0"
  description = "GARBAGE_REG004_TOML_DESC"
  requires-python = ">=3.11"
  dependencies = [
      "flask>=3.0",
      "sqlalchemy>=2.0",
      "psycopg2-binary>=2.9",
      "gunicorn>=22.0",
  ]

  [project.optional-dependencies]
  dev = [
      "pytest>=8.0",
      "ruff>=0.4",
      "black>=24.0",
      "mypy>=1.10",
  ]

  # GARBAGE_REG004_TOML_SECTION
  [tool.ruff]
  target-version = "py311"
  line-length = 99

  [tool.black]
  line-length = 99
  target-version = ["py311"]

  # GARBAGE_REG004_TOML_MYPY
  [tool.mypy]
  python_version = "3.11"
  strict = true
  warn_return_any = true

  [tool.pytest.ini_options]
  testpaths = ["tests"]
  addopts = "-v --tb=short"
  markers = [
      "GARBAGE_REG004_TOML_MARKER: placeholder",
  ]
