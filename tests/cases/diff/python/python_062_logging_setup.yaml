name: python_062_logging_setup
initial:
  logging_config.py: |
    import logging
    import logging.handlers
    from typing import Optional, Dict, Any, List
    from pathlib import Path
    from datetime import datetime
    import json
    import sys

    DEFAULT_FORMAT = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    JSON_FORMAT_KEYS = ["timestamp", "name", "level", "message", "extra"]

    class JsonFormatter(logging.Formatter):
        def __init__(self, include_extra: bool = True):
            super().__init__()
            self.include_extra = include_extra

        def format(self, record: logging.LogRecord) -> str:
            log_data = {
                "timestamp": datetime.utcnow().isoformat(),
                "name": record.name,
                "level": record.levelname,
                "message": record.getMessage(),
            }
            if self.include_extra and hasattr(record, "extra"):
                log_data["extra"] = record.extra
            if record.exc_info:
                log_data["exception"] = self.formatException(record.exc_info)
            return json.dumps(log_data)

    class ContextFilter(logging.Filter):
        def __init__(self, context: Dict[str, Any] = None):
            super().__init__()
            self.context = context or {}

        def filter(self, record: logging.LogRecord) -> bool:
            for key, value in self.context.items():
                setattr(record, key, value)
            return True

    class LoggerFactory:
        _loggers: Dict[str, logging.Logger] = {}

        @classmethod
        def get_logger(cls, name: str, level: str = "INFO") -> logging.Logger:
            if name in cls._loggers:
                return cls._loggers[name]
            logger = logging.getLogger(name)
            logger.setLevel(getattr(logging, level.upper()))
            cls._loggers[name] = logger
            return logger

    def setup_logging(level: str = "INFO", log_file: Optional[str] = None) -> logging.Logger:
        root_logger = logging.getLogger()
        root_logger.setLevel(getattr(logging, level.upper()))
        for handler in root_logger.handlers[:]:
            root_logger.removeHandler(handler)
        formatter = logging.Formatter(DEFAULT_FORMAT)
        console_handler = logging.StreamHandler(sys.stdout)
        console_handler.setFormatter(formatter)
        root_logger.addHandler(console_handler)
        return root_logger

  app.py: |
    from logging_config import setup_logging

    def main():
        logger = setup_logging()
        logger.info("Application started")

  unrelated/metrics_collector.py: |
    GARBAGE_PYTHON_062_001 = "metrics collector marker"
    GARBAGE_PYTHON_062_002 = "metrics interval constant"

    class MetricsCollector:
        GARBAGE_PYTHON_062_003 = "collector class marker"

        def __init__(self):
            pass

  unrelated/health_checker.py: |
    GARBAGE_PYTHON_062_004 = "health checker marker"
    GARBAGE_PYTHON_062_005 = "health check interval constant"

    class HealthChecker:
        GARBAGE_PYTHON_062_006 = "checker class marker"

        def __init__(self):
            pass

  unrelated/config_loader.py: |
    GARBAGE_PYTHON_062_007 = "config loader marker"
    GARBAGE_PYTHON_062_008 = "config format constant"

    class ConfigLoader:
        GARBAGE_PYTHON_062_009 = "loader class marker"

        def __init__(self):
            pass

changed:
  logging_config.py: |
    import logging
    import logging.handlers
    from typing import Optional, Dict, Any, List
    from pathlib import Path
    from datetime import datetime
    import json
    import sys

    DEFAULT_FORMAT = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    JSON_FORMAT_KEYS = ["timestamp", "name", "level", "message", "extra"]

    class JsonFormatter(logging.Formatter):
        def __init__(self, include_extra: bool = True):
            super().__init__()
            self.include_extra = include_extra

        def format(self, record: logging.LogRecord) -> str:
            log_data = {
                "timestamp": datetime.utcnow().isoformat(),
                "name": record.name,
                "level": record.levelname,
                "message": record.getMessage(),
            }
            if self.include_extra and hasattr(record, "extra"):
                log_data["extra"] = record.extra
            if record.exc_info:
                log_data["exception"] = self.formatException(record.exc_info)
            return json.dumps(log_data)

    class ContextFilter(logging.Filter):
        def __init__(self, context: Dict[str, Any] = None):
            super().__init__()
            self.context = context or {}

        def filter(self, record: logging.LogRecord) -> bool:
            for key, value in self.context.items():
                setattr(record, key, value)
            return True

        def update_context(self, **kwargs) -> None:
            self.context.update(kwargs)

    class LoggerFactory:
        _loggers: Dict[str, logging.Logger] = {}

        @classmethod
        def get_logger(cls, name: str, level: str = "INFO") -> logging.Logger:
            if name in cls._loggers:
                return cls._loggers[name]
            logger = logging.getLogger(name)
            logger.setLevel(getattr(logging, level.upper()))
            cls._loggers[name] = logger
            return logger

        @classmethod
        def configure_all(cls, level: str = "INFO") -> None:
            for logger in cls._loggers.values():
                logger.setLevel(getattr(logging, level.upper()))

    def setup_logging(
        level: str = "INFO",
        log_file: Optional[str] = None,
        json_format: bool = False,
        max_bytes: int = 10_000_000,
        backup_count: int = 5
    ) -> logging.Logger:
        root_logger = logging.getLogger()
        root_logger.setLevel(getattr(logging, level.upper()))

        for handler in root_logger.handlers[:]:
            root_logger.removeHandler(handler)

        if json_format:
            formatter = JsonFormatter()
        else:
            formatter = logging.Formatter(DEFAULT_FORMAT)

        console_handler = logging.StreamHandler(sys.stdout)
        console_handler.setFormatter(formatter)
        root_logger.addHandler(console_handler)

        if log_file:
            file_handler = logging.handlers.RotatingFileHandler(
                log_file,
                maxBytes=max_bytes,
                backupCount=backup_count
            )
            file_handler.setFormatter(formatter)
            root_logger.addHandler(file_handler)

        return root_logger

    def add_file_handler(
        logger: logging.Logger,
        filepath: str,
        level: str = "DEBUG"
    ) -> logging.FileHandler:
        handler = logging.FileHandler(filepath)
        handler.setLevel(getattr(logging, level.upper()))
        handler.setFormatter(logging.Formatter(DEFAULT_FORMAT))
        logger.addHandler(handler)
        return handler

assertions:
  must_include:
    - update_context
    - configure_all
    - json_format
    - max_bytes
    - backup_count
    - RotatingFileHandler
    - add_file_handler
  must_not_include:
    - GARBAGE_PYTHON_062_001
    - GARBAGE_PYTHON_062_002
    - GARBAGE_PYTHON_062_003
    - GARBAGE_PYTHON_062_004
    - GARBAGE_PYTHON_062_005
    - GARBAGE_PYTHON_062_006
    - GARBAGE_PYTHON_062_007
    - GARBAGE_PYTHON_062_008
    - GARBAGE_PYTHON_062_009
    - MetricsCollector
    - HealthChecker
    - ConfigLoader
    - metrics_collector.py
    - health_checker.py
    - config_loader.py
