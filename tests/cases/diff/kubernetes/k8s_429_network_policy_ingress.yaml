name: k8s_429_network_policy_ingress
initial:
  k8s/base/deployment.yaml: |
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: payment-service
      namespace: production
      labels:
        app: payment-service
        tier: backend
        security: high
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: payment-service
      template:
        metadata:
          labels:
            app: payment-service
            tier: backend
            security: high
        spec:
          containers:
          - name: payment
            image: registry.example.com/payment-service:v1.8.0
            ports:
            - containerPort: 8080
              name: http
            - containerPort: 8443
              name: https
            env:
            - name: ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: payment-secrets
                  key: encryption-key
            resources:
              requests:
                memory: "512Mi"
                cpu: "500m"
              limits:
                memory: "1Gi"
                cpu: "1000m"

  k8s/base/service.yaml: |
    apiVersion: v1
    kind: Service
    metadata:
      name: payment-service
      namespace: production
    spec:
      selector:
        app: payment-service
      ports:
      - name: http
        port: 80
        targetPort: 8080
      - name: https
        port: 443
        targetPort: 8443

  k8s/base/networkpolicy.yaml: |
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: default-deny-all
      namespace: production
    spec:
      podSelector: {}
      policyTypes:
      - Ingress
      - Egress

  k8s/base/secret.yaml: |
    apiVersion: v1
    kind: Secret
    metadata:
      name: payment-secrets
      namespace: production
    type: Opaque
    data:
      encryption-key: base64encodedkey==

  k8s/unrelated/database/postgresql-statefulset.yaml: |
    # GARBAGE_K8S_429_POSTGRES_SS
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: GARBAGE_K8S_429_POSTGRES_NAME
      namespace: database
    spec:
      serviceName: GARBAGE_K8S_429_POSTGRES_SVC
      replicas: 3
      selector:
        matchLabels:
          app: GARBAGE_K8S_429_POSTGRES_LABEL
      template:
        spec:
          containers:
          - name: postgres
            image: postgres:GARBAGE_K8S_429_POSTGRES_VERSION
            env:
            - name: POSTGRES_PASSWORD
              value: GARBAGE_K8S_429_PG_PASSWORD

  k8s/unrelated/cache/redis-cluster.yaml: |
    # GARBAGE_K8S_429_REDIS_CLUSTER
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: GARBAGE_K8S_429_REDIS_SS
      namespace: cache
    spec:
      serviceName: GARBAGE_K8S_429_REDIS_SVC
      replicas: 6
      selector:
        matchLabels:
          app: GARBAGE_K8S_429_REDIS_LABEL
      template:
        spec:
          containers:
          - name: redis
            image: redis:GARBAGE_K8S_429_REDIS_VERSION
            args:
            - GARBAGE_K8S_429_REDIS_ARGS

  k8s/unrelated/queue/kafka-cluster.yaml: |
    # GARBAGE_K8S_429_KAFKA_CLUSTER
    apiVersion: kafka.strimzi.io/v1beta2
    kind: Kafka
    metadata:
      name: GARBAGE_K8S_429_KAFKA_NAME
      namespace: kafka
    spec:
      kafka:
        replicas: GARBAGE_K8S_429_KAFKA_REPLICAS
        listeners:
        - name: GARBAGE_K8S_429_LISTENER_NAME
          port: GARBAGE_K8S_429_LISTENER_PORT

  terraform/main.tf: |
    # GARBAGE_K8S_429_TERRAFORM
    provider "aws" {
      region = "GARBAGE_K8S_429_AWS_REGION"
    }
    resource "aws_eks_cluster" "GARBAGE_K8S_429_EKS_CLUSTER" {
      name = "GARBAGE_K8S_429_CLUSTER_NAME"
    }

changed:
  k8s/base/networkpolicy.yaml: |
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: payment-service-ingress
      namespace: production
      labels:
        app: payment-service
        security: high
    spec:
      podSelector:
        matchLabels:
          app: payment-service
      policyTypes:
      - Ingress
      ingress:
      - from:
        - podSelector:
            matchLabels:
              role: api-gateway
        - podSelector:
            matchLabels:
              role: order-service
        - namespaceSelector:
            matchLabels:
              name: monitoring
          podSelector:
            matchLabels:
              app: prometheus
        ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8443

assertions:
  must_include:
  - payment-service-ingress
  - api-gateway
  - order-service
  must_not_include:
  - GARBAGE_K8S_429_POSTGRES_SS
  - GARBAGE_K8S_429_POSTGRES_NAME
  - GARBAGE_K8S_429_POSTGRES_SVC
  - GARBAGE_K8S_429_POSTGRES_LABEL
  - GARBAGE_K8S_429_POSTGRES_VERSION
  - GARBAGE_K8S_429_PG_PASSWORD
  - GARBAGE_K8S_429_REDIS_CLUSTER
  - GARBAGE_K8S_429_REDIS_SS
  - GARBAGE_K8S_429_REDIS_SVC
  - GARBAGE_K8S_429_REDIS_LABEL
  - GARBAGE_K8S_429_REDIS_VERSION
  - GARBAGE_K8S_429_REDIS_ARGS
  - GARBAGE_K8S_429_KAFKA_CLUSTER
  - GARBAGE_K8S_429_KAFKA_NAME
  - GARBAGE_K8S_429_KAFKA_REPLICAS
  - GARBAGE_K8S_429_LISTENER_NAME
  - GARBAGE_K8S_429_LISTENER_PORT
  - GARBAGE_K8S_429_TERRAFORM
  - GARBAGE_K8S_429_AWS_REGION
  - GARBAGE_K8S_429_EKS_CLUSTER
  - GARBAGE_K8S_429_CLUSTER_NAME
options:
  commit_message: Add network policy ingress rules for payment service
