name: k8s_438_service_topology
initial:
  k8s/base/deployment.yaml: |
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: cache-service
      namespace: production
      labels:
        app: cache-service
        tier: cache
    spec:
      replicas: 6
      selector:
        matchLabels:
          app: cache-service
      template:
        metadata:
          labels:
            app: cache-service
            tier: cache
        spec:
          topologySpreadConstraints:
          - maxSkew: 1
            topologyKey: topology.kubernetes.io/zone
            whenUnsatisfiable: DoNotSchedule
            labelSelector:
              matchLabels:
                app: cache-service
          containers:
          - name: cache
            image: registry.example.com/cache-service:v1.5.0
            ports:
            - containerPort: 6379
              name: redis
            - containerPort: 9121
              name: metrics
            resources:
              requests:
                memory: "1Gi"
                cpu: "500m"
              limits:
                memory: "2Gi"
                cpu: "1000m"

  k8s/base/service.yaml: |
    apiVersion: v1
    kind: Service
    metadata:
      name: cache-service
      namespace: production
      labels:
        app: cache-service
    spec:
      selector:
        app: cache-service
      ports:
      - name: redis
        port: 6379
        targetPort: 6379
      - name: metrics
        port: 9121
        targetPort: 9121

  k8s/base/pdb.yaml: |
    apiVersion: policy/v1
    kind: PodDisruptionBudget
    metadata:
      name: cache-service-pdb
      namespace: production
    spec:
      minAvailable: 4
      selector:
        matchLabels:
          app: cache-service

  k8s/base/servicemonitor.yaml: |
    apiVersion: monitoring.coreos.com/v1
    kind: ServiceMonitor
    metadata:
      name: cache-service
      namespace: production
    spec:
      selector:
        matchLabels:
          app: cache-service
      endpoints:
      - port: metrics
        interval: 15s

  k8s/unrelated/topology/node-labels.yaml: |
    # GARBAGE_K8S_438_NODE_LABELS
    apiVersion: v1
    kind: Node
    metadata:
      name: GARBAGE_K8S_438_NODE_NAME
      labels:
        topology.kubernetes.io/zone: GARBAGE_K8S_438_ZONE
        topology.kubernetes.io/region: GARBAGE_K8S_438_REGION
        node.kubernetes.io/instance-type: GARBAGE_K8S_438_INSTANCE

  k8s/unrelated/scheduling/priority-class.yaml: |
    # GARBAGE_K8S_438_PRIORITY
    apiVersion: scheduling.k8s.io/v1
    kind: PriorityClass
    metadata:
      name: GARBAGE_K8S_438_PRIORITY_NAME
    value: GARBAGE_K8S_438_PRIORITY_VALUE
    globalDefault: GARBAGE_K8S_438_GLOBAL_DEFAULT
    preemptionPolicy: GARBAGE_K8S_438_PREEMPTION

  k8s/unrelated/quota/resourcequota.yaml: |
    # GARBAGE_K8S_438_QUOTA
    apiVersion: v1
    kind: ResourceQuota
    metadata:
      name: GARBAGE_K8S_438_QUOTA_NAME
      namespace: quota
    spec:
      hard:
        requests.cpu: GARBAGE_K8S_438_CPU_REQUEST
        requests.memory: GARBAGE_K8S_438_MEM_REQUEST
        limits.cpu: GARBAGE_K8S_438_CPU_LIMIT

  cdk8s/main.ts: |
    // GARBAGE_K8S_438_CDK8S
    import { App } from 'cdk8s';
    const app = new App();
    const GARBAGE_K8S_438_CDK_VAR = "GARBAGE_K8S_438_CDK_VALUE";

changed:
  k8s/base/service.yaml: |
    apiVersion: v1
    kind: Service
    metadata:
      name: cache-service
      namespace: production
      labels:
        app: cache-service
      annotations:
        service.kubernetes.io/topology-aware-hints: "auto"
    spec:
      selector:
        app: cache-service
      ports:
      - name: redis
        port: 6379
        targetPort: 6379
      - name: metrics
        port: 9121
        targetPort: 9121
      topologyKeys:
      - "kubernetes.io/hostname"
      - "topology.kubernetes.io/zone"
      - "topology.kubernetes.io/region"
      - "*"

assertions:
  must_include:
  - cache-service
  - topologyKeys
  - topology-aware-hints
  must_not_include:
  - GARBAGE_K8S_438_NODE_LABELS
  - GARBAGE_K8S_438_NODE_NAME
  - GARBAGE_K8S_438_ZONE
  - GARBAGE_K8S_438_REGION
  - GARBAGE_K8S_438_INSTANCE
  - GARBAGE_K8S_438_PRIORITY
  - GARBAGE_K8S_438_PRIORITY_NAME
  - GARBAGE_K8S_438_PRIORITY_VALUE
  - GARBAGE_K8S_438_GLOBAL_DEFAULT
  - GARBAGE_K8S_438_PREEMPTION
  - GARBAGE_K8S_438_QUOTA
  - GARBAGE_K8S_438_QUOTA_NAME
  - GARBAGE_K8S_438_CPU_REQUEST
  - GARBAGE_K8S_438_MEM_REQUEST
  - GARBAGE_K8S_438_CPU_LIMIT
  - GARBAGE_K8S_438_CDK8S
  - GARBAGE_K8S_438_CDK_VAR
  - GARBAGE_K8S_438_CDK_VALUE
options:
  commit_message: Add service topology keys for zone-aware routing
