name: k8s_427_ingress_tls
initial:
  k8s/base/deployment.yaml: |
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: secure-api
      namespace: production
      labels:
        app: secure-api
        tier: backend
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: secure-api
      template:
        metadata:
          labels:
            app: secure-api
            tier: backend
        spec:
          containers:
          - name: api
            image: registry.example.com/secure-api:v2.1.0
            ports:
            - containerPort: 8080
              name: http
            env:
            - name: TLS_ENABLED
              value: "true"
            resources:
              requests:
                memory: "512Mi"
                cpu: "500m"
              limits:
                memory: "1Gi"
                cpu: "1000m"

  k8s/base/service.yaml: |
    apiVersion: v1
    kind: Service
    metadata:
      name: secure-api
      namespace: production
    spec:
      selector:
        app: secure-api
      ports:
      - name: http
        port: 80
        targetPort: 8080

  k8s/base/certificate.yaml: |
    apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: api-tls
      namespace: production
    spec:
      secretName: tls-cert
      issuerRef:
        name: letsencrypt-prod
        kind: ClusterIssuer
      dnsNames:
      - api.example.com
      - api-backup.example.com

  k8s/base/ingress.yaml: |
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: api-ingress
      namespace: production
      annotations:
        kubernetes.io/ingress.class: nginx
        cert-manager.io/cluster-issuer: letsencrypt-prod
    spec:
      rules:
      - host: api.example.com
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: secure-api
                port:
                  number: 80

  k8s/unrelated/vault/vault-injector.yaml: |
    # GARBAGE_K8S_427_VAULT_INJECTOR
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: GARBAGE_K8S_427_VAULT_AGENT
      namespace: vault
    spec:
      replicas: 2
      selector:
        matchLabels:
          app: GARBAGE_K8S_427_VAULT_LABEL
      template:
        spec:
          containers:
          - name: vault-agent
            image: hashicorp/vault:GARBAGE_K8S_427_VAULT_VERSION
            env:
            - name: VAULT_ADDR
              value: GARBAGE_K8S_427_VAULT_ADDR

  k8s/unrelated/backup/velero-schedule.yaml: |
    # GARBAGE_K8S_427_VELERO_BACKUP
    apiVersion: velero.io/v1
    kind: Schedule
    metadata:
      name: GARBAGE_K8S_427_BACKUP_SCHEDULE
      namespace: velero
    spec:
      schedule: GARBAGE_K8S_427_CRON_EXPR
      template:
        includedNamespaces:
        - GARBAGE_K8S_427_BACKUP_NS
        storageLocation: GARBAGE_K8S_427_STORAGE_LOC

  k8s/unrelated/cost/kubecost.yaml: |
    # GARBAGE_K8S_427_KUBECOST_CONFIG
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: GARBAGE_K8S_427_KUBECOST_CM
      namespace: kubecost
    data:
      prometheus-url: GARBAGE_K8S_427_PROM_URL
      cluster-id: GARBAGE_K8S_427_CLUSTER_ID

  Makefile: |
    # GARBAGE_K8S_427_MAKEFILE
    deploy:
    	kubectl apply -f k8s/base/
    	echo "GARBAGE_K8S_427_MAKE_DEPLOY"

changed:
  k8s/base/ingress.yaml: |
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: api-ingress
      namespace: production
      annotations:
        kubernetes.io/ingress.class: nginx
        cert-manager.io/cluster-issuer: letsencrypt-prod
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    spec:
      tls:
      - hosts:
        - api.example.com
        - api-backup.example.com
        secretName: tls-cert
      rules:
      - host: api.example.com
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: secure-api
                port:
                  number: 80
      - host: api-backup.example.com
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: secure-api
                port:
                  number: 80

assertions:
  must_include:
  - tls-cert
  - api.example.com
  - api-backup.example.com
  - ssl-redirect
  must_not_include:
  - GARBAGE_K8S_427_VAULT_INJECTOR
  - GARBAGE_K8S_427_VAULT_AGENT
  - GARBAGE_K8S_427_VAULT_LABEL
  - GARBAGE_K8S_427_VAULT_VERSION
  - GARBAGE_K8S_427_VAULT_ADDR
  - GARBAGE_K8S_427_VELERO_BACKUP
  - GARBAGE_K8S_427_BACKUP_SCHEDULE
  - GARBAGE_K8S_427_CRON_EXPR
  - GARBAGE_K8S_427_BACKUP_NS
  - GARBAGE_K8S_427_STORAGE_LOC
  - GARBAGE_K8S_427_KUBECOST_CONFIG
  - GARBAGE_K8S_427_KUBECOST_CM
  - GARBAGE_K8S_427_PROM_URL
  - GARBAGE_K8S_427_CLUSTER_ID
  - GARBAGE_K8S_427_MAKEFILE
  - GARBAGE_K8S_427_MAKE_DEPLOY
options:
  commit_message: Enable TLS for API ingress with cert-manager
