name: k8s_418_image_pull_secret
initial:
  k8s/secrets/registry-credentials.yaml: |
    apiVersion: v1
    kind: Secret
    metadata:
      name: private-registry-cred
      namespace: production
      labels:
        app: myapp
    type: kubernetes.io/dockerconfigjson
    data:
      .dockerconfigjson: eyJhdXRocyI6eyJwcml2YXRlLXJlZ2lzdHJ5LmlvIjp7InVzZXJuYW1lIjoiZGVwbG95IiwicGFzc3dvcmQiOiJzZWNyZXQiLCJlbWFpbCI6ImRlcGxveUBleGFtcGxlLmNvbSIsImF1dGgiOiJaR1Z3Ykc5NU9uTmxZM0psZEE9PSJ9fX0=

  k8s/apps/deployment.yaml: |
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: myapp
      namespace: production
      labels:
        app: myapp
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: myapp
      template:
        metadata:
          labels:
            app: myapp
        spec:
          containers:
          - name: app
            image: private-registry.io/myorg/myapp:v1.0.0
            ports:
            - containerPort: 8080
            resources:
              requests:
                memory: "256Mi"
                cpu: "250m"
              limits:
                memory: "512Mi"
                cpu: "500m"

  k8s/apps/service.yaml: |
    apiVersion: v1
    kind: Service
    metadata:
      name: myapp
      namespace: production
    spec:
      selector:
        app: myapp
      ports:
      - port: 80
        targetPort: 8080

  k8s/unrelated/harbor/harbor-core.yaml: |
    # GARBAGE_K8S_418_HARBOR_CORE
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: GARBAGE_K8S_418_HARBOR_NAME
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: GARBAGE_K8S_418_HARBOR_LABEL
      template:
        spec:
          containers:
          - name: core
            image: goharbor/harbor-core:GARBAGE_K8S_418_HARBOR_VERSION
            env:
            - name: DATABASE_TYPE
              value: GARBAGE_K8S_418_DB_TYPE

  k8s/unrelated/image-policy/kyverno.yaml: |
    # GARBAGE_K8S_418_KYVERNO_POLICY
    apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: GARBAGE_K8S_418_POLICY_NAME
    spec:
      validationFailureAction: GARBAGE_K8S_418_VALIDATION_ACTION
      rules:
      - name: GARBAGE_K8S_418_RULE_NAME
        match:
          resources:
            kinds: GARBAGE_K8S_418_RESOURCE_KINDS

changed:
  k8s/apps/deployment.yaml: |
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: myapp
      namespace: production
      labels:
        app: myapp
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: myapp
      template:
        metadata:
          labels:
            app: myapp
        spec:
          imagePullSecrets:
          - name: private-registry-cred
          - name: gcr-json-key
          containers:
          - name: app
            image: private-registry.io/myorg/myapp:v1.0.0
            imagePullPolicy: Always
            ports:
            - containerPort: 8080
            resources:
              requests:
                memory: "256Mi"
                cpu: "250m"
              limits:
                memory: "512Mi"
                cpu: "500m"

assertions:
  must_include:
  - imagePullSecrets
  - private-registry-cred
  - gcr-json-key
  - imagePullPolicy
  must_not_include:
  - GARBAGE_K8S_418_HARBOR_CORE
  - GARBAGE_K8S_418_HARBOR_NAME
  - GARBAGE_K8S_418_HARBOR_LABEL
  - GARBAGE_K8S_418_HARBOR_VERSION
  - GARBAGE_K8S_418_DB_TYPE
  - GARBAGE_K8S_418_KYVERNO_POLICY
  - GARBAGE_K8S_418_POLICY_NAME
  - GARBAGE_K8S_418_VALIDATION_ACTION
  - GARBAGE_K8S_418_RULE_NAME
  - GARBAGE_K8S_418_RESOURCE_KINDS
options:
  commit_message: Add image pull secrets for private registry
