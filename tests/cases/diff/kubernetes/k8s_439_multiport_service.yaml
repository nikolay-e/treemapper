name: k8s_439_multiport_service
initial:
  k8s/base/deployment.yaml: |
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: microservice-app
      namespace: production
      labels:
        app: microservice-app
        tier: backend
    spec:
      replicas: 4
      selector:
        matchLabels:
          app: microservice-app
      template:
        metadata:
          labels:
            app: microservice-app
            tier: backend
          annotations:
            prometheus.io/scrape: "true"
            prometheus.io/port: "9100"
        spec:
          containers:
          - name: app
            image: registry.example.com/microservice-app:v3.0.0
            ports:
            - containerPort: 8080
              name: http
            - containerPort: 8443
              name: https
            - containerPort: 9090
              name: grpc
            - containerPort: 9100
              name: metrics
            - containerPort: 8081
              name: health
            readinessProbe:
              httpGet:
                path: /ready
                port: 8081
              initialDelaySeconds: 5
              periodSeconds: 10
            livenessProbe:
              httpGet:
                path: /live
                port: 8081
              initialDelaySeconds: 15
              periodSeconds: 20
            resources:
              requests:
                memory: "512Mi"
                cpu: "500m"
              limits:
                memory: "1Gi"
                cpu: "1000m"

  k8s/base/service.yaml: |
    apiVersion: v1
    kind: Service
    metadata:
      name: microservice-app
      namespace: production
      labels:
        app: microservice-app
    spec:
      selector:
        app: microservice-app
      ports:
      - name: http
        port: 80
        targetPort: 8080

  k8s/base/configmap.yaml: |
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: microservice-config
      namespace: production
    data:
      LOG_FORMAT: json
      ENABLE_TRACING: "true"
      GRPC_MAX_MESSAGE_SIZE: "4194304"

  k8s/base/hpa.yaml: |
    apiVersion: autoscaling/v2
    kind: HorizontalPodAutoscaler
    metadata:
      name: microservice-app-hpa
      namespace: production
    spec:
      scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: microservice-app
      minReplicas: 4
      maxReplicas: 20
      metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 75

  k8s/unrelated/grpc/grpc-gateway.yaml: |
    # GARBAGE_K8S_439_GRPC_GW
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: GARBAGE_K8S_439_GRPC_INGRESS
      namespace: grpc
      annotations:
        nginx.ingress.kubernetes.io/backend-protocol: GARBAGE_K8S_439_PROTOCOL

  k8s/unrelated/metrics/podmonitor.yaml: |
    # GARBAGE_K8S_439_PODMONITOR
    apiVersion: monitoring.coreos.com/v1
    kind: PodMonitor
    metadata:
      name: GARBAGE_K8S_439_PM_NAME
      namespace: monitoring
    spec:
      selector:
        matchLabels:
          app: GARBAGE_K8S_439_PM_LABEL
      podMetricsEndpoints:
      - port: GARBAGE_K8S_439_METRICS_PORT

  k8s/unrelated/proxy/envoy-deployment.yaml: |
    # GARBAGE_K8S_439_ENVOY_PROXY
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: GARBAGE_K8S_439_ENVOY_DEPLOY
      namespace: proxy
    spec:
      selector:
        matchLabels:
          app: GARBAGE_K8S_439_ENVOY_LABEL
      template:
        spec:
          containers:
          - name: envoy
            image: GARBAGE_K8S_439_ENVOY_IMAGE
            ports:
            - containerPort: GARBAGE_K8S_439_ENVOY_PORT

  openapi/spec.yaml: |
    # GARBAGE_K8S_439_OPENAPI
    openapi: GARBAGE_K8S_439_OAS_VERSION
    info:
      title: GARBAGE_K8S_439_API_TITLE
      version: GARBAGE_K8S_439_API_VERSION

changed:
  k8s/base/service.yaml: |
    apiVersion: v1
    kind: Service
    metadata:
      name: microservice-app
      namespace: production
      labels:
        app: microservice-app
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9100"
    spec:
      selector:
        app: microservice-app
      ports:
      - name: http
        port: 80
        targetPort: 8080
        protocol: TCP
      - name: https
        port: 443
        targetPort: 8443
        protocol: TCP
      - name: grpc
        port: 9090
        targetPort: 9090
        protocol: TCP
        appProtocol: grpc
      - name: metrics
        port: 9100
        targetPort: 9100
        protocol: TCP
      - name: health
        port: 8081
        targetPort: 8081
        protocol: TCP

assertions:
  must_include:
  - microservice-app
  - grpc
  - metrics
  - health
  must_not_include:
  - GARBAGE_K8S_439_GRPC_GW
  - GARBAGE_K8S_439_GRPC_INGRESS
  - GARBAGE_K8S_439_PROTOCOL
  - GARBAGE_K8S_439_PODMONITOR
  - GARBAGE_K8S_439_PM_NAME
  - GARBAGE_K8S_439_PM_LABEL
  - GARBAGE_K8S_439_METRICS_PORT
  - GARBAGE_K8S_439_ENVOY_PROXY
  - GARBAGE_K8S_439_ENVOY_DEPLOY
  - GARBAGE_K8S_439_ENVOY_LABEL
  - GARBAGE_K8S_439_ENVOY_IMAGE
  - GARBAGE_K8S_439_ENVOY_PORT
  - GARBAGE_K8S_439_OPENAPI
  - GARBAGE_K8S_439_OAS_VERSION
  - GARBAGE_K8S_439_API_TITLE
  - GARBAGE_K8S_439_API_VERSION
options:
  commit_message: Add multi-port service with HTTP, HTTPS, gRPC, metrics, and health endpoints
