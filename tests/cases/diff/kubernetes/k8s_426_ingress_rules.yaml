name: k8s_426_ingress_rules
initial:
  k8s/base/deployment.yaml: |
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: api-gateway
      namespace: production
      labels:
        app: api-gateway
        component: ingress
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: api-gateway
      template:
        metadata:
          labels:
            app: api-gateway
            component: ingress
        spec:
          containers:
          - name: api
            image: registry.example.com/api-gateway:v1.5.0
            ports:
            - containerPort: 8080
              name: http
            - containerPort: 8443
              name: https
            resources:
              requests:
                memory: "256Mi"
                cpu: "250m"
              limits:
                memory: "512Mi"
                cpu: "500m"

  k8s/base/service.yaml: |
    apiVersion: v1
    kind: Service
    metadata:
      name: api-gateway
      namespace: production
      labels:
        app: api-gateway
    spec:
      selector:
        app: api-gateway
      ports:
      - name: http
        port: 80
        targetPort: 8080
      - name: https
        port: 443
        targetPort: 8443

  k8s/base/ingress.yaml: |
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: api-ingress
      namespace: production
      annotations:
        kubernetes.io/ingress.class: nginx
    spec:
      rules: []

  k8s/base/configmap.yaml: |
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: api-config
      namespace: production
    data:
      LOG_LEVEL: info
      API_TIMEOUT: "30"
      RATE_LIMIT: "1000"

  k8s/unrelated/logging/fluentd-daemonset.yaml: |
    # GARBAGE_K8S_426_FLUENTD_LOGGING
    apiVersion: apps/v1
    kind: DaemonSet
    metadata:
      name: GARBAGE_K8S_426_FLUENTD_DS
      namespace: logging
    spec:
      selector:
        matchLabels:
          app: GARBAGE_K8S_426_FLUENTD_LABEL
      template:
        spec:
          containers:
          - name: fluentd
            image: fluent/fluentd:GARBAGE_K8S_426_FLUENTD_VERSION
            env:
            - name: FLUENT_CONF
              value: GARBAGE_K8S_426_FLUENT_CONFIG

  k8s/unrelated/monitoring/prometheus-operator.yaml: |
    # GARBAGE_K8S_426_PROMETHEUS_OPERATOR
    apiVersion: monitoring.coreos.com/v1
    kind: ServiceMonitor
    metadata:
      name: GARBAGE_K8S_426_SERVICEMONITOR
      namespace: monitoring
    spec:
      selector:
        matchLabels:
          team: GARBAGE_K8S_426_PROMETHEUS_TEAM
      endpoints:
      - port: GARBAGE_K8S_426_METRICS_PORT

  k8s/unrelated/security/network-policies.yaml: |
    # GARBAGE_K8S_426_SECURITY_POLICIES
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: GARBAGE_K8S_426_DEFAULT_DENY
      namespace: security
    spec:
      podSelector:
        matchLabels:
          security: GARBAGE_K8S_426_SECURITY_LABEL
      policyTypes:
      - Ingress
      - Egress

  scripts/deploy.sh: |
    #!/bin/bash
    # GARBAGE_K8S_426_DEPLOY_SCRIPT
    kubectl apply -f k8s/base/
    echo "GARBAGE_K8S_426_DEPLOY_COMPLETE"

changed:
  k8s/base/ingress.yaml: |
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: api-ingress
      namespace: production
      annotations:
        kubernetes.io/ingress.class: nginx
        nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    spec:
      rules:
      - host: api.example.com
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 80
      - host: api-v2.example.com
        http:
          paths:
          - path: /v2
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 80

assertions:
  must_include:
  - api.example.com
  - api-v2.example.com
  - api-gateway
  must_not_include:
  - GARBAGE_K8S_426_FLUENTD_LOGGING
  - GARBAGE_K8S_426_FLUENTD_DS
  - GARBAGE_K8S_426_FLUENTD_LABEL
  - GARBAGE_K8S_426_FLUENTD_VERSION
  - GARBAGE_K8S_426_FLUENT_CONFIG
  - GARBAGE_K8S_426_PROMETHEUS_OPERATOR
  - GARBAGE_K8S_426_SERVICEMONITOR
  - GARBAGE_K8S_426_PROMETHEUS_TEAM
  - GARBAGE_K8S_426_METRICS_PORT
  - GARBAGE_K8S_426_SECURITY_POLICIES
  - GARBAGE_K8S_426_DEFAULT_DENY
  - GARBAGE_K8S_426_SECURITY_LABEL
  - GARBAGE_K8S_426_DEPLOY_SCRIPT
  - GARBAGE_K8S_426_DEPLOY_COMPLETE
options:
  commit_message: Add ingress rules for API gateway
