name: dep_403_test_mock_side_effect
initial:
  src/api_client.py: |
    import requests

    class ApiClient:
        def __init__(self, base_url: str):
            self.base_url = base_url

        def fetch_data(self, endpoint: str) -> dict:
            response = requests.get(f"{self.base_url}/{endpoint}")
            response.raise_for_status()
            return response.json()

        def post_data(self, endpoint: str, data: dict) -> dict:
            response = requests.post(f"{self.base_url}/{endpoint}", json=data)
            response.raise_for_status()
            return response.json()
  src/data_processor.py: |
    from src.api_client import ApiClient

    class DataProcessor:
        def __init__(self, client: ApiClient):
            self.client = client

        def process_user_data(self, user_id: int) -> dict:
            data = self.client.fetch_data(f"users/{user_id}")
            return {"processed": True, "user": data}

        def process_with_retry(self, endpoint: str, retries: int = 3) -> dict:
            for attempt in range(retries):
                try:
                    return self.client.fetch_data(endpoint)
                except Exception as e:
                    if attempt == retries - 1:
                        raise
            return {}
  tests/test_data_processor.py: |
    from unittest.mock import Mock
    from src.data_processor import DataProcessor

    def test_process_user_data():
        mock_client = Mock()
        mock_client.fetch_data.return_value = {"id": 1, "name": "Test"}
        processor = DataProcessor(mock_client)
        result = processor.process_user_data(1)
        assert result["processed"] is True
changed:
  tests/test_data_processor.py: |
    from unittest.mock import Mock
    import pytest
    from src.data_processor import DataProcessor

    def test_process_user_data():
        mock_client = Mock()
        mock_client.fetch_data.return_value = {"id": 1, "name": "Test"}
        processor = DataProcessor(mock_client)
        result = processor.process_user_data(1)
        assert result["processed"] is True

    def test_retry_on_failure():
        mock_client = Mock()
        mock_client.fetch_data.side_effect = [
            ConnectionError("First failure"),
            ConnectionError("Second failure"),
            {"id": 1, "data": "success"},
        ]
        processor = DataProcessor(mock_client)
        result = processor.process_with_retry("users/1", retries=3)
        assert result["data"] == "success"
        assert mock_client.fetch_data.call_count == 3

    def test_retry_exhausted_raises():
        mock_client = Mock()
        mock_client.fetch_data.side_effect = [
            ConnectionError("Failure 1"),
            ConnectionError("Failure 2"),
            ConnectionError("Failure 3"),
        ]
        processor = DataProcessor(mock_client)
        with pytest.raises(ConnectionError):
            processor.process_with_retry("users/1", retries=3)
assertions:
  must_include:
  - test_data_processor.py
  must_not_include:
  - garbage_marker_12345
