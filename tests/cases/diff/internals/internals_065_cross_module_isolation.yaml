name: internals_065_cross_module_isolation
initial:
  app/auth/login.py: |
    def authenticate_user(username: str, password: str) -> bool:
        return len(username) > 0 and len(password) > 0

    def create_session(user_id: int) -> str:
        return f"session_{user_id}"

  app/billing/subscription.py: |
    SUBSCRIPTION_MODULE_MARKER_PPP111 = "billing"

    def authenticate_payment(card_number: str, cvv: str) -> bool:
        AUTH_PAYMENT_MARKER_QQQ222 = True
        return len(card_number) == 16

    def create_invoice(amount: float) -> dict:
        CREATE_INVOICE_MARKER_RRR333 = True
        return {"amount": amount}

    class SubscriptionManager:
        MANAGER_MARKER_SSS444 = "subscription"

        def create_session(self, plan_id: int) -> str:
            SESSION_MARKER_TTT555 = True
            return f"subscription_{plan_id}"

  app/analytics/tracking.py: |
    TRACKING_MODULE_MARKER_UUU666 = "analytics"

    def authenticate_api_key(api_key: str) -> bool:
        AUTH_API_MARKER_VVV777 = True
        return len(api_key) == 32

    def create_event(event_type: str) -> dict:
        CREATE_EVENT_MARKER_WWW888 = True
        return {"type": event_type}

    class SessionTracker:
        TRACKER_MARKER_XXX999 = "tracker"

        def create_session(self, visitor_id: str) -> str:
            VISITOR_SESSION_MARKER_YYY000 = True
            return f"visit_{visitor_id}"

changed:
  app/auth/login.py: |
    import hashlib

    def authenticate_user(username: str, password: str) -> bool:
        if not username or not password:
            return False
        return len(username) >= 3 and len(password) >= 8

    def create_session(user_id: int) -> str:
        token = hashlib.sha256(f"user_{user_id}".encode()).hexdigest()[:16]
        return f"session_{token}"

    def invalidate_session(session_id: str) -> bool:
        return session_id.startswith("session_")

assertions:
  must_include:
    - authenticate_user
    - create_session
    - hashlib

  must_not_include:
    - SUBSCRIPTION_MODULE_MARKER_PPP111
    - AUTH_PAYMENT_MARKER_QQQ222
    - CREATE_INVOICE_MARKER_RRR333
    - MANAGER_MARKER_SSS444
    - SESSION_MARKER_TTT555
    - TRACKING_MODULE_MARKER_UUU666
    - AUTH_API_MARKER_VVV777
    - CREATE_EVENT_MARKER_WWW888
    - TRACKER_MARKER_XXX999
    - VISITOR_SESSION_MARKER_YYY000
    - authenticate_payment
    - create_invoice
    - SubscriptionManager
    - authenticate_api_key
    - create_event
    - SessionTracker

options:
  commit_message: "Improve authentication security"
  add_garbage: false
  skip_garbage_check: true
