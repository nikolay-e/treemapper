name: ruby_002_block_yield
initial:
  retry_helper.rb: |
    module RetryHelper
      def with_retry(max_attempts: 3)
        attempts = 0
        begin
          attempts += 1
          yield
        rescue StandardError => e
          retry if attempts < max_attempts
          raise e
        end
      end
    end
  service.rb: |
    # Initial
    class Service
    end
  garbage.rb: |
    garbage_helper_unused_67890 = "never invoked"
    unused_marker_12345 = "not used"
changed:
  service.rb: |
    require_relative 'retry_helper'

    class Service
      include RetryHelper

      def fetch_data
        with_retry(max_attempts: 5) do
          raise "Error" if rand < 0.5
        end
      end
    end
assertions:
  must_include:
  - service.rb
  - with_retry
  must_not_include:
  - garbage_helper_unused_67890
  - unused_marker_12345
