src/app.py: |
  import os
  import pwd
  from flask import Flask, jsonify

  app = Flask(__name__)

  @app.route('/whoami')
  def whoami():
      return jsonify(
          uid=os.getuid(),
          gid=os.getgid(),
          user=pwd.getpwuid(os.getuid()).pw_name
      )

  @app.route('/health')
  def health():
      return jsonify(status='ok')

  if __name__ == '__main__':
      app.run(host='0.0.0.0', port=8080)
requirements.txt: |
  flask==2.3.0
  gunicorn==21.2.0
Dockerfile: |
  FROM python:3.12-slim-bookworm AS base
  ENV PYTHONDONTWRITEBYTECODE=1
  ENV PYTHONUNBUFFERED=1

  FROM base AS dependencies
  WORKDIR /app
  COPY requirements.txt .
  RUN pip install --no-cache-dir -r requirements.txt

  FROM base AS production
  WORKDIR /app

  # Create non-root user with specific UID/GID for Kubernetes compatibility
  RUN groupadd --gid 1000 appgroup && \
      useradd --uid 1000 --gid appgroup --shell /bin/bash --create-home appuser && \
      mkdir -p /app/data /app/logs && \
      chown -R appuser:appgroup /app

  COPY --from=dependencies /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
  COPY --from=dependencies /usr/local/bin /usr/local/bin
  COPY --chown=appuser:appgroup src/ ./src/

  # Switch to non-root user
  USER appuser:appgroup

  EXPOSE 8080

  HEALTHCHECK --interval=30s --timeout=5s \
      CMD curl -f http://localhost:8080/health || exit 1

  CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:8080", "src.app:app"]
scripts/setup_user.sh: |
  #!/bin/bash
  # GARBAGE_DOCKER_512_SETUP_MARKER_001
  GARBAGE_DOCKER_512_SETUP_VAR_002="user_setup"
  useradd -m appuser
tests/test_security.py: |
  # GARBAGE_DOCKER_512_TEST_MARKER_003
  GARBAGE_DOCKER_512_TEST_SEC_004 = {"uid": 1000}
  def test_non_root():
      pass
docs/security.md: |
  # Security
  GARBAGE_DOCKER_512_SEC_DOC_005
  GARBAGE_DOCKER_512_USER_006="appuser"
k8s/pod-security.yaml: |
  # GARBAGE_DOCKER_512_K8S_MARKER_007
  apiVersion: v1
  GARBAGE_DOCKER_512_PSP_008: restricted
compliance/checks.yaml: |
  # GARBAGE_DOCKER_512_COMPLIANCE_MARKER_009
  GARBAGE_DOCKER_512_CHECK_010: non-root
