name: docker_503_copy_source
initial:
  requirements.txt: |
    flask==2.3.0
    flask-cors==4.0.0
    requests==2.31.0
    pydantic==2.5.0
    sqlalchemy==2.0.23
  src/app.py: |
    from flask import Flask
    from flask_cors import CORS
    app = Flask(__name__)
    CORS(app)
  src/models.py: |
    from sqlalchemy import Column, Integer, String
    from sqlalchemy.ext.declarative import declarative_base
    Base = declarative_base()
    class User(Base):
        __tablename__ = 'users'
        id = Column(Integer, primary_key=True)
        name = Column(String(100))
  Dockerfile: |
    FROM python:3.11-slim
    RUN pip install flask flask-cors
    COPY src/app.py /app/
    WORKDIR /app
    CMD ["python", "app.py"]
  scripts/seed_data.sh: |
    #!/bin/bash
    # GARBAGE_DOCKER_503_SEED_MARKER_001
    GARBAGE_DOCKER_503_SEED_VAR_002="seed_config"
    python manage.py seed
  tests/test_models.py: |
    # GARBAGE_DOCKER_503_TEST_MARKER_003
    GARBAGE_DOCKER_503_TEST_CONFIG_004 = {"db": "test"}
    def test_user_model():
        pass
  docs/api.md: |
    # API Documentation
    GARBAGE_DOCKER_503_API_DOC_005
    GARBAGE_DOCKER_503_ENDPOINT_006="/api/v1"
  config/logging.yaml: |
    # GARBAGE_DOCKER_503_LOG_MARKER_007
    version: 1
    GARBAGE_DOCKER_503_LOG_CONFIG_008: debug
changed:
  Dockerfile: |
    FROM python:3.12-slim-bookworm AS base
    ENV PYTHONDONTWRITEBYTECODE=1
    ENV PYTHONUNBUFFERED=1
    WORKDIR /app

    FROM base AS dependencies
    COPY requirements.txt .
    RUN pip install --no-cache-dir -r requirements.txt

    FROM base AS production
    COPY --from=dependencies /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
    COPY --from=dependencies /usr/local/bin /usr/local/bin

    # Copy source files with proper structure
    COPY src/ ./src/
    COPY config/ ./config/

    # Create non-root user
    RUN useradd --create-home --shell /bin/bash appuser
    USER appuser

    EXPOSE 5000
    CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5000", "src.app:app"]
assertions:
  must_include:
    - COPY requirements.txt
    - COPY src/ ./src/
    - COPY config/ ./config/
    - COPY --from=dependencies
    - useradd
  must_not_include:
    - GARBAGE_DOCKER_503_SEED_MARKER_001
    - GARBAGE_DOCKER_503_SEED_VAR_002
    - GARBAGE_DOCKER_503_TEST_MARKER_003
    - GARBAGE_DOCKER_503_TEST_CONFIG_004
    - GARBAGE_DOCKER_503_API_DOC_005
    - GARBAGE_DOCKER_503_ENDPOINT_006
    - GARBAGE_DOCKER_503_LOG_MARKER_007
    - GARBAGE_DOCKER_503_LOG_CONFIG_008
options:
  commit_message: Refactor COPY instructions with multi-stage build
