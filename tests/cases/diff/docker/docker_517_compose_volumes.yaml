name: docker_517_compose_volumes
initial:
  app.py: |
    import os
    import json
    from pathlib import Path

    DATA_DIR = Path(os.getenv("DATA_DIR", "/app/data"))
    CONFIG_DIR = Path(os.getenv("CONFIG_DIR", "/app/config"))
    LOGS_DIR = Path(os.getenv("LOGS_DIR", "/app/logs"))

    def read_config(name: str) -> dict:
        config_file = CONFIG_DIR / f"{name}.json"
        if config_file.exists():
            with open(config_file) as f:
                return json.load(f)
        return {}

    def write_data(filename: str, data: dict) -> None:
        DATA_DIR.mkdir(parents=True, exist_ok=True)
        with open(DATA_DIR / filename, 'w') as f:
            json.dump(data, f)

    def append_log(message: str) -> None:
        LOGS_DIR.mkdir(parents=True, exist_ok=True)
        with open(LOGS_DIR / "app.log", 'a') as f:
            f.write(f"{message}\n")

    if __name__ == "__main__":
        config = read_config("app")
        write_data("output.json", {"status": "ok"})
        append_log("Application started")
  requirements.txt: |
    pyyaml==6.0.0
  Dockerfile: |
    FROM python:3.12-slim
    WORKDIR /app
    COPY requirements.txt .
    RUN pip install -r requirements.txt
    COPY app.py .
    CMD ["python", "app.py"]
  docker-compose.yml: |
    version: '3.8'
    services:
      api:
        build: .
  scripts/volume_backup.sh: |
    #!/bin/bash
    # GARBAGE_DOCKER_517_BACKUP_MARKER_a1b2c3
    GARBAGE_DOCKER_517_BACKUP_TARGET_d4e5f6="/backup"
    tar -czf backup.tar.gz ./data
  tests/test_volumes.py: |
    # GARBAGE_DOCKER_517_TEST_MARKER_g7h8i9
    GARBAGE_DOCKER_517_TEST_MOUNT_j0k1l2 = "/tmp/test"
    def test_volume_mount():
        pass
  docs/storage.md: |
    # Storage Configuration
    GARBAGE_DOCKER_517_DOC_MARKER_m3n4o5
    GARBAGE_DOCKER_517_VOLUMES_p6q7r8="data,config,logs"
  k8s/pvc.yaml: |
    # GARBAGE_DOCKER_517_K8S_MARKER_s9t0u1
    apiVersion: v1
    GARBAGE_DOCKER_517_PVC_SIZE_v2w3x4: 10Gi
  ansible/storage.yml: |
    # GARBAGE_DOCKER_517_ANSIBLE_MARKER_y5z6a7
    GARBAGE_DOCKER_517_NFS_PATH_b8c9d0: /mnt/nfs
changed:
  docker-compose.yml: |
    version: '3.8'

    services:
      api:
        build:
          context: .
          dockerfile: Dockerfile
        environment:
          - DATA_DIR=/app/data
          - CONFIG_DIR=/app/config
          - LOGS_DIR=/app/logs
        volumes:
          # Named volume for persistent data
          - app_data:/app/data

          # Bind mount for config (read-only)
          - ./config:/app/config:ro

          # Named volume for logs
          - app_logs:/app/logs

          # Temporary filesystem for cache
          - type: tmpfs
            target: /app/cache
            tmpfs:
              size: 50M

        restart: unless-stopped
        healthcheck:
          test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data') else 1)"]
          interval: 30s
          timeout: 5s
          retries: 3

      backup:
        image: alpine:latest
        volumes:
          - app_data:/source:ro
          - ./backups:/dest
        command: sh -c "tar -czf /dest/backup-$$(date +%Y%m%d-%H%M%S).tar.gz /source"
        profiles:
          - maintenance

    volumes:
      app_data:
        driver: local
        driver_opts:
          type: none
          o: bind
          device: ${PWD}/persistent/data

      app_logs:
        driver: local
        labels:
          com.example.description: "Application logs"
          com.example.retention: "30d"
assertions:
  must_include:
    - 'volumes:'
  must_not_include:
    - GARBAGE_DOCKER_517_BACKUP_MARKER_a1b2c3
    - GARBAGE_DOCKER_517_BACKUP_TARGET_d4e5f6
    - GARBAGE_DOCKER_517_TEST_MARKER_g7h8i9
    - GARBAGE_DOCKER_517_TEST_MOUNT_j0k1l2
    - GARBAGE_DOCKER_517_DOC_MARKER_m3n4o5
    - GARBAGE_DOCKER_517_VOLUMES_p6q7r8
    - GARBAGE_DOCKER_517_K8S_MARKER_s9t0u1
    - GARBAGE_DOCKER_517_PVC_SIZE_v2w3x4
    - GARBAGE_DOCKER_517_ANSIBLE_MARKER_y5z6a7
    - GARBAGE_DOCKER_517_NFS_PATH_b8c9d0
options:
  commit_message: Add comprehensive compose volumes with driver options and tmpfs
