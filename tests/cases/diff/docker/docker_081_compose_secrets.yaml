name: docker_081_compose_secrets
initial:
  docker-compose.yml: |
    version: '3.8'
    services:
      app:
        build: .
        secrets:
          - db_password
    secrets:
      db_password:
        file: ./secrets/db_password.txt
  src/config.py: |
    def get_db_password():
        with open("/run/secrets/db_password") as f:
            return f.read().strip()
changed:
  docker-compose.yml: |
    version: '3.8'
    services:
      app:
        build: .
        secrets:
          - db_password
          - api_key
    secrets:
      db_password:
        file: ./secrets/db_password.txt
      api_key:
        external: true
assertions:
  must_include:
    - get_db_password
options:
  commit_message: add api key secret
