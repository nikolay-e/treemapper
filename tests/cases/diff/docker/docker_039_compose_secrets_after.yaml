api/src/app.py: |
  from flask import Flask, jsonify
  from pathlib import Path
  import os

  app = Flask(__name__)

  def load_secret(name: str) -> str:
      secret_path = Path(f'/run/secrets/{name}')
      if secret_path.exists():
          return secret_path.read_text().strip()
      return os.environ.get(name.upper(), '')

  @app.route('/health')
  def health():
      db_password = load_secret('db_password')
      return jsonify(status='ok', db_configured=bool(db_password))
api/requirements.txt: |
  flask==2.3.0
  gunicorn==21.2.0
  psycopg2-binary==2.9.9
api/Dockerfile: |
  FROM python:3.12-slim
  WORKDIR /app
  COPY requirements.txt .
  RUN pip install -r requirements.txt
  COPY src/ ./src/
  CMD ["gunicorn", "-b", "0.0.0.0:8080", "src.app:app"]
secrets/db_password.txt: |
  supersecret123
secrets/api_key.txt: |
  sk-1234567890abcdef
docker-compose.yml: |
  version: '3.8'

  services:
    api:
      build: ./api
      ports:
        - "8080:8080"
      environment:
        - DATABASE_URL=postgresql://postgres:$(cat /run/secrets/db_password)@db:5432/app
      secrets:
        - db_password
        - api_key
        - source: jwt_private_key
          target: jwt_key
          uid: '1000'
          gid: '1000'
          mode: 0400
      depends_on:
        db:
          condition: service_healthy

    db:
      image: postgres:16-alpine
      environment:
        - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
        - POSTGRES_USER=postgres
        - POSTGRES_DB=app
      secrets:
        - db_password
      volumes:
        - postgres_data:/var/lib/postgresql/data
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U postgres"]
        interval: 10s
        timeout: 5s
        retries: 5

    redis:
      image: redis:7-alpine
      command: >
        sh -c 'redis-server --requirepass "$$(cat /run/secrets/redis_password)"'
      secrets:
        - redis_password

  secrets:
    db_password:
      file: ./secrets/db_password.txt
    api_key:
      file: ./secrets/api_key.txt
    jwt_private_key:
      file: ./secrets/jwt_private.pem
    redis_password:
      file: ./secrets/redis_password.txt

  volumes:
    postgres_data:
scripts/rotate_secrets.sh: |
  #!/bin/bash
  # GARBAGE_DOCKER_524_ROTATE_MARKER_001
  GARBAGE_DOCKER_524_ROTATE_VAR_002="weekly"
  openssl rand -base64 32 > secrets/db_password.txt
tests/test_secrets.py: |
  # GARBAGE_DOCKER_524_TEST_MARKER_003
  GARBAGE_DOCKER_524_TEST_SEC_004 = {"path": "/run/secrets"}
  def test_secrets_mounted():
      pass
docs/secrets.md: |
  # Secret Management
  GARBAGE_DOCKER_524_SEC_DOC_005
  GARBAGE_DOCKER_524_VAULT_006="hashicorp"
vault/policy.hcl: |
  # GARBAGE_DOCKER_524_VAULT_MARKER_007
  GARBAGE_DOCKER_524_POLICY_008: read
k8s/sealed-secret.yaml: |
  # GARBAGE_DOCKER_524_K8S_MARKER_009
  GARBAGE_DOCKER_524_SEALED_010: encrypted
