src/logger.py: |
  import logging
  import os
  import sys
  from typing import Optional

  LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")
  LOG_FORMAT = os.getenv("LOG_FORMAT", "%(asctime)s - %(name)s - %(levelname)s - %(message)s")

  def setup_logging(level: Optional[str] = None):
      effective_level = level or LOG_LEVEL
      logging.basicConfig(
          level=getattr(logging, effective_level),
          format=LOG_FORMAT,
          stream=sys.stdout
      )

  logger = logging.getLogger(__name__)
  setup_logging()

  def log_event(message: str):
      logger.info(message)

  def log_error(message: str, exc: Optional[Exception] = None):
      logger.error(message, exc_info=exc)
src/app.py: |
  from flask import Flask, jsonify, request
  from logger import log_event, log_error

  app = Flask(__name__)

  @app.route('/health')
  def health():
      log_event("Health check requested")
      return jsonify(status='ok')

  @app.route('/api/process', methods=['POST'])
  def process():
      data = request.get_json()
      log_event(f"Processing request: {data}")
      return jsonify(result='processed')
requirements.txt: |
  flask==2.3.0
  gunicorn==21.2.0
Dockerfile: |
  FROM python:3.12-slim
  WORKDIR /app
  COPY requirements.txt .
  RUN pip install --no-cache-dir -r requirements.txt
  COPY src/ ./src/
  EXPOSE 8080
  CMD ["gunicorn", "-b", "0.0.0.0:8080", "src.app:app"]
docker-compose.yml: |
  version: '3.8'
  services:
    app:
      build: .
      ports:
        - "8080:8080"
      environment:
        - LOG_LEVEL=INFO
      logging:
        driver: json-file
        options:
          max-size: "10m"
          max-file: "3"
          labels: "app,env"
scripts/collect_logs.sh: |
  #!/bin/bash
  # GARBAGE_DOCK_014_COLLECT_SCRIPT_A
  GARBAGE_DOCK_014_LOG_PATH_B="/var/log/app"
  docker logs app_1 > /tmp/logs.txt
tests/test_logging.py: |
  # GARBAGE_DOCK_014_LOG_TEST_A
  GARBAGE_DOCK_014_LOG_FIXTURE_B = "test-log-entry"
  def test_log_event():
      pass
docs/observability.md: |
  # Observability Guide
  GARBAGE_DOCK_014_OBS_DOC_A
  GARBAGE_DOCK_014_LOKI_ENDPOINT_B="http://loki:3100"
k8s/fluentbit-configmap.yaml: |
  # GARBAGE_DOCK_014_FLUENTBIT_A
  apiVersion: v1
  GARBAGE_DOCK_014_PARSER_TYPE_B: json
monitoring/promtail.yml: |
  # GARBAGE_DOCK_014_PROMTAIL_A
  GARBAGE_DOCK_014_SCRAPE_CONFIG_B: docker
