src/health.py: |
  from flask import Flask, jsonify
  import os
  import psutil
  import time

  app = Flask(__name__)
  START_TIME = time.time()

  @app.route("/health")
  def health():
      return jsonify({"status": "healthy"})

  @app.route("/healthz")
  def healthz():
      uptime = time.time() - START_TIME
      memory = psutil.virtual_memory()
      cpu = psutil.cpu_percent(interval=0.1)

      return jsonify({
          "status": "healthy",
          "uptime_seconds": round(uptime, 2),
          "memory_percent": memory.percent,
          "cpu_percent": cpu,
          "checks": {
              "memory": memory.percent < 90,
              "cpu": cpu < 80
          }
      })

  @app.route("/ready")
  def ready():
      # Check if dependencies are available
      checks = {
          "database": check_database(),
          "cache": check_cache()
      }
      status = "ready" if all(checks.values()) else "not_ready"
      code = 200 if status == "ready" else 503
      return jsonify({"status": status, "checks": checks}), code

  def check_database():
      # Simulated check
      return True

  def check_cache():
      # Simulated check
      return True
src/app.py: |
  from health import app, check_database, check_cache

  @app.route("/api/data")
  def get_data():
      return {"data": [1, 2, 3]}

  if __name__ == "__main__":
      app.run(host="0.0.0.0", port=8080)
requirements.txt: |
  flask==2.3.0
  psutil==5.9.0
  gunicorn==21.2.0
Dockerfile: |
  FROM python:3.12-slim
  WORKDIR /app
  RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
  COPY requirements.txt .
  RUN pip install -r requirements.txt
  COPY src/ ./src/
  CMD ["gunicorn", "-b", "0.0.0.0:8080", "src.app:app"]
docker-compose.yml: |
  version: '3.8'

  services:
    api:
      build:
        context: .
        dockerfile: Dockerfile
      ports:
        - "8080:8080"
      healthcheck:
        test: ["CMD", "curl", "-sf", "http://localhost:8080/healthz"]
        interval: 10s
        timeout: 5s
        retries: 3
        start_period: 30s
      restart: unless-stopped
      deploy:
        resources:
          limits:
            memory: 512M

    api-sidecar:
      image: alpine:latest
      command: sh -c "while true; do wget -q -O- http://api:8080/health || echo 'unhealthy'; sleep 30; done"
      depends_on:
        api:
          condition: service_healthy

    db:
      image: postgres:16-alpine
      environment:
        POSTGRES_PASSWORD: secret
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U postgres || exit 1"]
        interval: 5s
        timeout: 3s
        retries: 5
        start_period: 10s

    redis:
      image: redis:7-alpine
      healthcheck:
        test: ["CMD", "redis-cli", "--no-auth-warning", "ping"]
        interval: 5s
        timeout: 3s
        retries: 3

    nginx:
      image: nginx:alpine
      ports:
        - "80:80"
      volumes:
        - ./nginx.conf:/etc/nginx/nginx.conf:ro
      healthcheck:
        test: ["CMD", "nginx", "-t"]
        interval: 30s
        timeout: 10s
        retries: 3
      depends_on:
        api:
          condition: service_healthy

    elasticsearch:
      image: elasticsearch:8.11.0
      environment:
        - discovery.type=single-node
        - xpack.security.enabled=false
      healthcheck:
        test: ["CMD-SHELL", "curl -sf http://localhost:9200/_cluster/health || exit 1"]
        interval: 30s
        timeout: 10s
        retries: 5
        start_period: 60s
scripts/health_check.sh: |
  #!/bin/bash
  # GARBAGE_DOCKER_078_HEALTH_MARKER_a1b2c3
  GARBAGE_DOCKER_078_CHECK_URL_d4e5f6="localhost:8080"
  curl -f http://localhost:8080/health
tests/test_health.py: |
  # GARBAGE_DOCKER_078_TEST_MARKER_g7h8i9
  GARBAGE_DOCKER_078_TEST_ENDPOINT_j0k1l2 = "/healthz"
  def test_health_endpoint():
      pass
docs/monitoring.md: |
  # Health Check Configuration
  GARBAGE_DOCKER_078_MON_DOC_m3n4o5
  GARBAGE_DOCKER_078_ENDPOINTS_p6q7r8="/health,/healthz,/ready"
prometheus/alerts.yml: |
  # GARBAGE_DOCKER_078_PROM_MARKER_s9t0u1
  groups:
    - name: health
      GARBAGE_DOCKER_078_ALERT_EXPR_v2w3x4: up == 0
grafana/dashboard.json: |
  {
    "GARBAGE_DOCKER_078_GRAFANA_MARKER_y5z6a7": true,
    "GARBAGE_DOCKER_078_PANEL_TYPE_b8c9d0": "graph"
  }
