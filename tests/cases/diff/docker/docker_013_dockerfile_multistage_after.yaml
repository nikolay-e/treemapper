src/index.ts: |
  import express from 'express';
  import cors from 'cors';
  import helmet from 'helmet';
  import compression from 'compression';

  const app = express();
  const PORT = parseInt(process.env.PORT || '3000', 10);

  app.use(cors());
  app.use(helmet());
  app.use(compression());
  app.use(express.json());

  export function init() {
      console.log("App initialized");
  }

  app.get('/health', (req, res) => {
      res.json({ status: 'healthy', version: process.env.APP_VERSION || 'unknown' });
  });

  app.get('/api/users', (req, res) => {
      res.json({ users: [] });
  });

  app.listen(PORT, () => {
      init();
      console.log(`Server running on port ${PORT}`);
  });
src/config.ts: |
  export interface AppConfig {
      port: number;
      nodeEnv: string;
      logLevel: string;
  }

  export function loadConfig(): AppConfig {
      return {
          port: parseInt(process.env.PORT || '3000', 10),
          nodeEnv: process.env.NODE_ENV || 'development',
          logLevel: process.env.LOG_LEVEL || 'info'
      };
  }
package.json: |
  {
    "name": "api-server",
    "version": "1.0.0",
    "main": "dist/index.js",
    "scripts": {
      "build": "tsc",
      "start": "node dist/index.js",
      "dev": "ts-node src/index.ts"
    },
    "dependencies": {
      "express": "^4.18.2",
      "cors": "^2.8.5",
      "helmet": "^7.1.0",
      "compression": "^1.7.4"
    },
    "devDependencies": {
      "typescript": "^5.3.3",
      "@types/node": "^20.10.0",
      "@types/express": "^4.17.21",
      "@types/compression": "^1.7.5"
    }
  }
tsconfig.json: |
  {
    "compilerOptions": {
      "target": "ES2022",
      "module": "commonjs",
      "outDir": "./dist",
      "rootDir": "./src",
      "strict": true,
      "esModuleInterop": true,
      "skipLibCheck": true,
      "forceConsistentCasingInFileNames": true
    },
    "include": ["src/**/*"],
    "exclude": ["node_modules", "dist"]
  }
Dockerfile: |
  # =============================================================================
  # Stage 1: Dependencies
  # =============================================================================
  FROM node:20-alpine AS deps
  WORKDIR /app

  # Install dependencies for native modules
  RUN apk add --no-cache python3 make g++

  # Copy package files
  COPY package*.json ./

  # Install all dependencies (including dev for build)
  RUN npm ci

  # =============================================================================
  # Stage 2: Builder
  # =============================================================================
  FROM node:20-alpine AS builder
  WORKDIR /app

  # Copy dependencies from deps stage
  COPY --from=deps /app/node_modules ./node_modules
  COPY package*.json ./
  COPY tsconfig.json ./
  COPY src ./src

  # Build the application
  RUN npm run build

  # Prune dev dependencies
  RUN npm prune --production

  # =============================================================================
  # Stage 3: Production
  # =============================================================================
  FROM node:20-alpine AS production
  WORKDIR /app

  # Security: Create non-root user
  RUN addgroup -g 1001 -S nodejs && \
      adduser -S nodejs -u 1001 && \
      apk add --no-cache dumb-init

  # Copy production artifacts
  COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
  COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
  COPY --from=builder --chown=nodejs:nodejs /app/package.json ./

  # Build arguments for versioning
  ARG APP_VERSION=0.0.0
  ARG GIT_SHA=unknown
  ENV APP_VERSION=${APP_VERSION}
  ENV GIT_SHA=${GIT_SHA}
  ENV NODE_ENV=production
  ENV PORT=3000

  # Switch to non-root user
  USER nodejs

  EXPOSE 3000

  # Health check
  HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
      CMD wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1

  # Use dumb-init to handle signals properly
  ENTRYPOINT ["dumb-init", "--"]
  CMD ["node", "dist/index.js"]
scripts/build.sh: |
  #!/bin/bash
  # GARBAGE_DOCKER_083_BUILD_MARKER_a1b2c3
  GARBAGE_DOCKER_083_BUILD_TARGET_d4e5f6="production"
  docker build -t api:latest .
tests/api.test.ts: |
  // GARBAGE_DOCKER_083_TEST_MARKER_g7h8i9
  const GARBAGE_DOCKER_083_TEST_ENV_j0k1l2 = "test";
  describe('API', () => {
      it('should initialize', () => {});
  });
docs/build.md: |
  # Build Process
  GARBAGE_DOCKER_083_BUILD_DOC_m3n4o5
  GARBAGE_DOCKER_083_STAGES_p6q7r8="builder,production"
.github/workflows/docker.yml: |
  # GARBAGE_DOCKER_083_GH_MARKER_s9t0u1
  name: Docker Build
  GARBAGE_DOCKER_083_WORKFLOW_v2w3x4: push
k8s/deployment.yaml: |
  # GARBAGE_DOCKER_083_K8S_MARKER_y5z6a7
  apiVersion: apps/v1
  GARBAGE_DOCKER_083_IMAGE_TAG_b8c9d0: latest
