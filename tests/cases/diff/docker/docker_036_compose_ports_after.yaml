api/src/app.py: |
  from flask import Flask, jsonify
  from prometheus_client import make_wsgi_app, Counter
  from werkzeug.middleware.dispatcher import DispatcherMiddleware

  REQUEST_COUNT = Counter('http_requests_total', 'Total HTTP requests')

  app = Flask(__name__)

  @app.route('/health')
  def health():
      REQUEST_COUNT.inc()
      return jsonify(status='ok')

  @app.route('/api/v1/data')
  def get_data():
      REQUEST_COUNT.inc()
      return jsonify(data=[1, 2, 3])

  app.wsgi_app = DispatcherMiddleware(app.wsgi_app, {
      '/metrics': make_wsgi_app()
  })
api/Dockerfile: |
  FROM python:3.12-slim
  WORKDIR /app
  COPY requirements.txt .
  RUN pip install -r requirements.txt
  COPY src/ ./src/
  CMD ["gunicorn", "-b", "0.0.0.0:8080", "src.app:app"]
api/requirements.txt: |
  flask==2.3.0
  gunicorn==21.2.0
  prometheus-client==0.19.0
docker-compose.yml: |
  version: '3.8'

  services:
    api:
      build: ./api
      ports:
        # Host:Container format with explicit protocol
        - "8080:8080/tcp"
        # Metrics port - only accessible from localhost
        - "127.0.0.1:9090:9090/tcp"
        # Debug port - only in development
        - "127.0.0.1:5678:5678/tcp"
        # UDP port for specific use cases
        - "8125:8125/udp"
        # Range of ports
        - "3000-3005:3000-3005/tcp"
      expose:
        # Internal ports (not published to host)
        - "8081"
        - "8082"
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
        interval: 30s
        timeout: 10s
        retries: 3

    prometheus:
      image: prom/prometheus:v2.48.0
      ports:
        - "127.0.0.1:9091:9090/tcp"
      volumes:
        - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro

    grafana:
      image: grafana/grafana:10.2.2
      ports:
        - "127.0.0.1:3000:3000/tcp"
      environment:
        - GF_SECURITY_ADMIN_PASSWORD=admin
scripts/port_forward.sh: |
  #!/bin/bash
  # GARBAGE_DOCKER_521_PORT_MARKER_001
  GARBAGE_DOCKER_521_PORT_VAR_002="forward"
  kubectl port-forward svc/api 8080:8080
tests/test_ports.py: |
  # GARBAGE_DOCKER_521_TEST_MARKER_003
  GARBAGE_DOCKER_521_TEST_PORT_004 = {"http": 8080}
  def test_port_binding():
      pass
docs/ports.md: |
  # Port Configuration
  GARBAGE_DOCKER_521_PORT_DOC_005
  GARBAGE_DOCKER_521_MAPPING_006="8080:80"
firewall/rules.yaml: |
  # GARBAGE_DOCKER_521_FW_MARKER_007
  GARBAGE_DOCKER_521_RULE_008: allow-http
nginx/upstream.conf: |
  # GARBAGE_DOCKER_521_NGINX_MARKER_009
  GARBAGE_DOCKER_521_UPSTREAM_010: api_servers
