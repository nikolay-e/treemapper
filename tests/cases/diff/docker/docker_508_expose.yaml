name: docker_508_expose
initial:
  src/app.py: |
    from flask import Flask, jsonify
    from prometheus_client import make_wsgi_app
    from werkzeug.middleware.dispatcher import DispatcherMiddleware

    app = Flask(__name__)

    @app.route('/health')
    def health():
        return jsonify(status='ok')

    @app.route('/ready')
    def ready():
        return jsonify(status='ready')

    app.wsgi_app = DispatcherMiddleware(app.wsgi_app, {
        '/metrics': make_wsgi_app()
    })

    if __name__ == '__main__':
        app.run(host='0.0.0.0', port=8080)
  requirements.txt: |
    flask==2.3.0
    gunicorn==21.2.0
    prometheus-client==0.19.0
  Dockerfile: |
    FROM python:3.11-slim
    WORKDIR /app
    COPY requirements.txt .
    RUN pip install -r requirements.txt
    COPY src/ ./src/
    CMD ["python", "src/app.py"]
  scripts/health_check.sh: |
    #!/bin/bash
    # GARBAGE_DOCKER_508_HEALTH_MARKER_001
    GARBAGE_DOCKER_508_HEALTH_VAR_002="check"
    curl http://localhost:8080/health
  tests/test_endpoints.py: |
    # GARBAGE_DOCKER_508_TEST_MARKER_003
    GARBAGE_DOCKER_508_TEST_CONFIG_004 = {"port": 8080}
    def test_health():
        pass
  docs/networking.md: |
    # Networking
    GARBAGE_DOCKER_508_NET_DOC_005
    GARBAGE_DOCKER_508_PORTS_006="8080,9090"
  k8s/service.yaml: |
    # GARBAGE_DOCKER_508_K8S_MARKER_007
    apiVersion: v1
    GARBAGE_DOCKER_508_K8S_SVC_008: Service
  monitoring/alerts.yaml: |
    # GARBAGE_DOCKER_508_ALERT_MARKER_009
    GARBAGE_DOCKER_508_ALERT_CONFIG_010: critical
changed:
  Dockerfile: |
    FROM python:3.12-slim-bookworm AS base
    ENV PYTHONDONTWRITEBYTECODE=1
    ENV PYTHONUNBUFFERED=1

    FROM base AS dependencies
    WORKDIR /app
    COPY requirements.txt .
    RUN pip install --no-cache-dir -r requirements.txt

    FROM base AS production
    WORKDIR /app

    COPY --from=dependencies /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
    COPY --from=dependencies /usr/local/bin /usr/local/bin
    COPY src/ ./src/

    RUN useradd --create-home appuser
    USER appuser

    # Application port
    EXPOSE 8080/tcp

    # Metrics port for Prometheus scraping
    EXPOSE 9090/tcp

    # Debug port (only used in development)
    EXPOSE 5678/tcp

    HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
        CMD curl -f http://localhost:8080/health || exit 1

    CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:8080", "src.app:app"]
assertions:
  must_include:
    - EXPOSE 8080/tcp
    - EXPOSE 9090/tcp
    - EXPOSE 5678/tcp
    - HEALTHCHECK
    - curl -f http://localhost:8080/health
  must_not_include:
    - GARBAGE_DOCKER_508_HEALTH_MARKER_001
    - GARBAGE_DOCKER_508_HEALTH_VAR_002
    - GARBAGE_DOCKER_508_TEST_MARKER_003
    - GARBAGE_DOCKER_508_TEST_CONFIG_004
    - GARBAGE_DOCKER_508_NET_DOC_005
    - GARBAGE_DOCKER_508_PORTS_006
    - GARBAGE_DOCKER_508_K8S_MARKER_007
    - GARBAGE_DOCKER_508_K8S_SVC_008
    - GARBAGE_DOCKER_508_ALERT_MARKER_009
    - GARBAGE_DOCKER_508_ALERT_CONFIG_010
options:
  commit_message: Add multiple EXPOSE directives with protocol specification
