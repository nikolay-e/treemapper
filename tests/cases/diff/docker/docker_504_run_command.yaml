name: docker_504_run_command
initial:
  requirements.txt: |
    flask==2.3.0
    gunicorn==21.2.0
    psycopg2-binary==2.9.9
    alembic==1.13.0
    sqlalchemy==2.0.23
  src/app.py: |
    from flask import Flask
    from sqlalchemy import create_engine
    app = Flask(__name__)
    engine = create_engine(os.environ['DATABASE_URL'])
  alembic/env.py: |
    from alembic import context
    from src.models import Base
    target_metadata = Base.metadata
  Dockerfile: |
    FROM python:3.11-slim
    COPY requirements.txt .
    RUN pip install -r requirements.txt
    COPY . .
    CMD ["python", "app.py"]
  scripts/ci_test.sh: |
    #!/bin/bash
    # GARBAGE_DOCKER_504_CI_MARKER_001
    GARBAGE_DOCKER_504_CI_VAR_002="test_runner"
    pytest tests/
  tests/conftest.py: |
    # GARBAGE_DOCKER_504_CONFTEST_MARKER_003
    GARBAGE_DOCKER_504_FIXTURE_004 = "fixture_value"
    import pytest
  docs/database.md: |
    # Database Setup
    GARBAGE_DOCKER_504_DB_DOC_005
    GARBAGE_DOCKER_504_MIGRATION_006="alembic upgrade head"
  k8s/deployment.yaml: |
    # GARBAGE_DOCKER_504_K8S_MARKER_007
    apiVersion: apps/v1
    GARBAGE_DOCKER_504_K8S_CONFIG_008: deployment
changed:
  Dockerfile: |
    FROM python:3.12-slim-bookworm AS base
    ENV PYTHONDONTWRITEBYTECODE=1
    ENV PYTHONUNBUFFERED=1

    # Install system dependencies
    RUN apt-get update && apt-get install -y --no-install-recommends \
        libpq-dev \
        curl \
        && rm -rf /var/lib/apt/lists/* \
        && apt-get clean

    FROM base AS dependencies
    WORKDIR /app
    COPY requirements.txt .

    # Install Python dependencies with optimizations
    RUN pip install --no-cache-dir --upgrade pip && \
        pip install --no-cache-dir -r requirements.txt && \
        find /usr/local -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true

    FROM base AS production
    WORKDIR /app

    # Copy dependencies from builder
    COPY --from=dependencies /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
    COPY --from=dependencies /usr/local/bin /usr/local/bin

    # Copy application code
    COPY src/ ./src/
    COPY alembic/ ./alembic/
    COPY alembic.ini ./

    # Create non-root user and set permissions
    RUN useradd --create-home --shell /bin/bash appuser && \
        chown -R appuser:appuser /app

    USER appuser
    EXPOSE 8000

    CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:8000", "src.app:app"]
assertions:
  must_include:
    - RUN apt-get update
    - apt-get install -y --no-install-recommends
    - rm -rf /var/lib/apt/lists/*
    - pip install --no-cache-dir
    - find /usr/local -type d -name __pycache__
  must_not_include:
    - GARBAGE_DOCKER_504_CI_MARKER_001
    - GARBAGE_DOCKER_504_CI_VAR_002
    - GARBAGE_DOCKER_504_CONFTEST_MARKER_003
    - GARBAGE_DOCKER_504_FIXTURE_004
    - GARBAGE_DOCKER_504_DB_DOC_005
    - GARBAGE_DOCKER_504_MIGRATION_006
    - GARBAGE_DOCKER_504_K8S_MARKER_007
    - GARBAGE_DOCKER_504_K8S_CONFIG_008
options:
  commit_message: Optimize RUN commands with layer caching and cleanup
