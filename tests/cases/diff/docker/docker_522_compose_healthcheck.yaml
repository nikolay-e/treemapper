name: docker_522_compose_healthcheck
initial:
  api/src/app.py: |
    from flask import Flask, jsonify
    import redis
    import psycopg2
    import os

    app = Flask(__name__)

    def check_redis():
        r = redis.from_url(os.environ.get('REDIS_URL', 'redis://redis:6379/0'))
        return r.ping()

    def check_database():
        conn = psycopg2.connect(os.environ.get('DATABASE_URL'))
        cur = conn.cursor()
        cur.execute('SELECT 1')
        return cur.fetchone()[0] == 1

    @app.route('/health')
    def health():
        return jsonify(status='ok')

    @app.route('/ready')
    def ready():
        redis_ok = check_redis()
        db_ok = check_database()
        if redis_ok and db_ok:
            return jsonify(status='ready', redis=redis_ok, db=db_ok)
        return jsonify(status='not_ready'), 503
  api/requirements.txt: |
    flask==2.3.0
    redis==5.0.1
    psycopg2-binary==2.9.9
  api/Dockerfile: |
    FROM python:3.12-slim
    WORKDIR /app
    COPY requirements.txt .
    RUN pip install -r requirements.txt
    COPY src/ ./src/
    CMD ["gunicorn", "-b", "0.0.0.0:8080", "src.app:app"]
  docker-compose.yml: |
    version: '3.8'
    services:
      api:
        build: ./api
      redis:
        image: redis:7-alpine
      db:
        image: postgres:16-alpine
  scripts/health_monitor.sh: |
    #!/bin/bash
    # GARBAGE_DOCKER_522_HEALTH_MARKER_001
    GARBAGE_DOCKER_522_HEALTH_VAR_002="monitor"
    while true; do curl localhost/health; sleep 30; done
  tests/test_health.py: |
    # GARBAGE_DOCKER_522_TEST_MARKER_003
    GARBAGE_DOCKER_522_TEST_HEALTH_004 = {"endpoint": "/health"}
    def test_health():
        pass
  docs/healthcheck.md: |
    # Health Checks
    GARBAGE_DOCKER_522_HC_DOC_005
    GARBAGE_DOCKER_522_ENDPOINTS_006="/health,/ready"
  monitoring/probes.yaml: |
    # GARBAGE_DOCKER_522_PROBE_MARKER_007
    GARBAGE_DOCKER_522_LIVENESS_008: /health
  alerting/rules.yaml: |
    # GARBAGE_DOCKER_522_ALERT_MARKER_009
    GARBAGE_DOCKER_522_ALERT_010: service_down
changed:
  docker-compose.yml: |
    version: '3.8'

    services:
      api:
        build: ./api
        ports:
          - "8080:8080"
        environment:
          - REDIS_URL=redis://redis:6379/0
          - DATABASE_URL=postgresql://postgres:secret@db:5432/app
        depends_on:
          redis:
            condition: service_healthy
          db:
            condition: service_healthy
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:8080/ready"]
          interval: 30s
          timeout: 10s
          retries: 5
          start_period: 60s

      redis:
        image: redis:7-alpine
        command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
        volumes:
          - redis_data:/data
        healthcheck:
          test: ["CMD", "redis-cli", "ping"]
          interval: 10s
          timeout: 5s
          retries: 5
          start_period: 10s

      db:
        image: postgres:16-alpine
        environment:
          - POSTGRES_USER=postgres
          - POSTGRES_PASSWORD=secret
          - POSTGRES_DB=app
        volumes:
          - postgres_data:/var/lib/postgresql/data
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U postgres -d app"]
          interval: 10s
          timeout: 5s
          retries: 5
          start_period: 30s

    volumes:
      redis_data:
      postgres_data:
assertions:
  must_include:
    - "healthcheck:"
    - "condition: service_healthy"
    - "start_period: 60s"
    - "pg_isready -U postgres"
    - "redis-cli"
    - "retries: 5"
    - "interval: 10s"
  must_not_include:
    - GARBAGE_DOCKER_522_HEALTH_MARKER_001
    - GARBAGE_DOCKER_522_HEALTH_VAR_002
    - GARBAGE_DOCKER_522_TEST_MARKER_003
    - GARBAGE_DOCKER_522_TEST_HEALTH_004
    - GARBAGE_DOCKER_522_HC_DOC_005
    - GARBAGE_DOCKER_522_ENDPOINTS_006
    - GARBAGE_DOCKER_522_PROBE_MARKER_007
    - GARBAGE_DOCKER_522_LIVENESS_008
    - GARBAGE_DOCKER_522_ALERT_MARKER_009
    - GARBAGE_DOCKER_522_ALERT_010
options:
  commit_message: Add comprehensive healthchecks with service dependencies
