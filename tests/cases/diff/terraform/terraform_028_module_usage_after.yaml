modules/vpc/main.tf: |
  locals {
    azs = slice(data.aws_availability_zones.available.names, 0, var.az_count)
  }

  data "aws_availability_zones" "available" {
    state = "available"
  }

  resource "aws_vpc" "main" {
    cidr_block           = var.cidr_block
    enable_dns_hostnames = true
    enable_dns_support   = true

    tags = merge(var.tags, {
      Name = "${var.name}-vpc"
    })
  }

  resource "aws_subnet" "public" {
    count                   = var.az_count
    vpc_id                  = aws_vpc.main.id
    cidr_block              = cidrsubnet(var.cidr_block, 8, count.index)
    availability_zone       = local.azs[count.index]
    map_public_ip_on_launch = true

    tags = merge(var.tags, {
      Name = "${var.name}-public-${count.index + 1}"
      Tier = "public"
    })
  }

  resource "aws_subnet" "private" {
    count             = var.az_count
    vpc_id            = aws_vpc.main.id
    cidr_block        = cidrsubnet(var.cidr_block, 8, count.index + 100)
    availability_zone = local.azs[count.index]

    tags = merge(var.tags, {
      Name = "${var.name}-private-${count.index + 1}"
      Tier = "private"
    })
  }

  resource "aws_internet_gateway" "main" {
    vpc_id = aws_vpc.main.id

    tags = merge(var.tags, {
      Name = "${var.name}-igw"
    })
  }

  resource "aws_eip" "nat" {
    count  = var.single_nat_gateway ? 1 : var.az_count
    domain = "vpc"

    tags = merge(var.tags, {
      Name = "${var.name}-nat-eip-${count.index + 1}"
    })
  }

  resource "aws_nat_gateway" "main" {
    count         = var.single_nat_gateway ? 1 : var.az_count
    allocation_id = aws_eip.nat[count.index].id
    subnet_id     = aws_subnet.public[count.index].id

    tags = merge(var.tags, {
      Name = "${var.name}-nat-${count.index + 1}"
    })
  }
modules/vpc/variables.tf: |
  variable "name" {
    type        = string
    description = "Name prefix for resources"
  }

  variable "cidr_block" {
    type        = string
    description = "VPC CIDR block"
  }

  variable "az_count" {
    type        = number
    default     = 3
    description = "Number of availability zones"
  }

  variable "single_nat_gateway" {
    type        = bool
    default     = false
    description = "Use single NAT gateway for all AZs"
  }

  variable "tags" {
    type        = map(string)
    default     = {}
    description = "Common tags for all resources"
  }
main.tf: |
  terraform {
    required_version = ">= 1.5.0"

    required_providers {
      aws = {
        source  = "hashicorp/aws"
        version = "~> 5.0"
      }
    }

    backend "s3" {
      bucket         = "terraform-state-bucket"
      key            = "prod/terraform.tfstate"
      region         = "us-east-1"
      encrypt        = true
      dynamodb_table = "terraform-locks"
    }
  }

  provider "aws" {
    region = var.aws_region

    default_tags {
      tags = {
        Environment = var.environment
        ManagedBy   = "terraform"
        Project     = var.project_name
      }
    }
  }

  locals {
    common_tags = {
      Environment = var.environment
      Project     = var.project_name
    }
  }

  module "vpc" {
    source = "./modules/vpc"

    name               = "${var.environment}-${var.project_name}"
    cidr_block         = var.vpc_cidr
    az_count           = var.az_count
    single_nat_gateway = var.environment != "prod"
    tags               = local.common_tags
  }

  module "rds" {
    source = "./modules/rds"

    name               = "${var.environment}-${var.project_name}-db"
    subnet_ids         = module.vpc.private_subnet_ids
    security_group_ids = [aws_security_group.rds.id]
    kms_key_arn        = aws_kms_key.main.arn
    username           = var.db_username
    password           = var.db_password
    multi_az           = var.environment == "prod"
    skip_final_snapshot = var.environment != "prod"
    tags               = local.common_tags
  }

  resource "aws_security_group" "rds" {
    name        = "${var.environment}-rds-sg"
    description = "Security group for RDS"
    vpc_id      = module.vpc.vpc_id

    ingress {
      from_port       = 5432
      to_port         = 5432
      protocol        = "tcp"
      security_groups = [aws_security_group.app.id]
    }

    tags = local.common_tags
  }

  resource "aws_security_group" "app" {
    name        = "${var.environment}-app-sg"
    description = "Security group for application"
    vpc_id      = module.vpc.vpc_id

    egress {
      from_port   = 0
      to_port     = 0
      protocol    = "-1"
      cidr_blocks = ["0.0.0.0/0"]
    }

    tags = local.common_tags
  }

  resource "aws_kms_key" "main" {
    description             = "KMS key for ${var.environment}"
    deletion_window_in_days = 30
    enable_key_rotation     = true

    tags = local.common_tags
  }

  resource "aws_kms_alias" "main" {
    name          = "alias/${var.environment}-${var.project_name}"
    target_key_id = aws_kms_key.main.key_id
  }
deprecated/old_modules_GARBAGE_TF_mod468a.tf: |
  # GARBAGE_TF_mod468a - Legacy module references
  module "legacy_vpc_GARBAGE_TF_mod468a" {
    source = "git::https://github.com/old-org/terraform-modules.git//vpc?ref=v0.1.0"
    cidr   = "172.31.0.0/16"
  }

  module "legacy_rds_GARBAGE_TF_mod468a" {
    source     = "./modules/legacy-rds"
    vpc_id     = module.legacy_vpc_GARBAGE_TF_mod468a.vpc_id
    db_name    = "legacy_db_GARBAGE_TF_mod468a"
  }
scripts/migrate_modules_GARBAGE_TF_mod468b.py: |
  # GARBAGE_TF_mod468b - Module migration script
  def migrate_legacy_modules_GARBAGE_TF_mod468b():
      print("Migrating legacy modules GARBAGE_TF_mod468b")
modules/vpc/outputs.tf: |
  output "vpc_id" {
    description = "VPC ID"
    value       = aws_vpc.main.id
  }

  output "vpc_cidr_block" {
    description = "VPC CIDR block"
    value       = aws_vpc.main.cidr_block
  }

  output "public_subnet_ids" {
    description = "Public subnet IDs"
    value       = aws_subnet.public[*].id
  }

  output "private_subnet_ids" {
    description = "Private subnet IDs"
    value       = aws_subnet.private[*].id
  }

  output "nat_gateway_ids" {
    description = "NAT gateway IDs"
    value       = aws_nat_gateway.main[*].id
  }
modules/rds/main.tf: |
  resource "aws_db_subnet_group" "main" {
    name       = "${var.name}-db-subnet-group"
    subnet_ids = var.subnet_ids

    tags = var.tags
  }

  resource "aws_db_instance" "main" {
    identifier           = var.name
    engine               = var.engine
    engine_version       = var.engine_version
    instance_class       = var.instance_class
    allocated_storage    = var.allocated_storage
    storage_encrypted    = true
    kms_key_id           = var.kms_key_arn
    db_subnet_group_name = aws_db_subnet_group.main.name
    vpc_security_group_ids = var.security_group_ids
    username             = var.username
    password             = var.password
    multi_az             = var.multi_az
    skip_final_snapshot  = var.skip_final_snapshot

    tags = var.tags
  }
modules/rds/variables.tf: |
  variable "name" {
    type = string
  }

  variable "engine" {
    type    = string
    default = "postgres"
  }

  variable "engine_version" {
    type    = string
    default = "15"
  }

  variable "instance_class" {
    type    = string
    default = "db.t3.medium"
  }

  variable "allocated_storage" {
    type    = number
    default = 100
  }

  variable "subnet_ids" {
    type = list(string)
  }

  variable "security_group_ids" {
    type = list(string)
  }

  variable "kms_key_arn" {
    type = string
  }

  variable "username" {
    type      = string
    sensitive = true
  }

  variable "password" {
    type      = string
    sensitive = true
  }

  variable "multi_az" {
    type    = bool
    default = true
  }

  variable "skip_final_snapshot" {
    type    = bool
    default = false
  }

  variable "tags" {
    type    = map(string)
    default = {}
  }
modules/rds/outputs.tf: |
  output "endpoint" {
    description = "RDS endpoint"
    value       = aws_db_instance.main.endpoint
  }

  output "port" {
    description = "RDS port"
    value       = aws_db_instance.main.port
  }

  output "arn" {
    description = "RDS instance ARN"
    value       = aws_db_instance.main.arn
  }
