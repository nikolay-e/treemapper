name: terraform_443_api_gateway_route
initial:
  modules/api_gateway/main.tf: |
    resource "aws_apigatewayv2_api" "main" {
      name          = var.api_name
      protocol_type = "HTTP"
      description   = var.description

      cors_configuration {
        allow_origins     = var.cors_origins
        allow_methods     = var.cors_methods
        allow_headers     = var.cors_headers
        max_age           = var.cors_max_age
        allow_credentials = var.cors_allow_credentials
      }

      tags = var.tags
    }

    resource "aws_apigatewayv2_stage" "main" {
      api_id      = aws_apigatewayv2_api.main.id
      name        = var.stage_name
      auto_deploy = var.auto_deploy

      access_log_settings {
        destination_arn = aws_cloudwatch_log_group.api.arn
        format = jsonencode({
          requestId      = "$context.requestId"
          ip             = "$context.identity.sourceIp"
          requestTime    = "$context.requestTime"
          httpMethod     = "$context.httpMethod"
          routeKey       = "$context.routeKey"
          status         = "$context.status"
          responseLength = "$context.responseLength"
        })
      }

      default_route_settings {
        throttling_burst_limit = var.throttling_burst_limit
        throttling_rate_limit  = var.throttling_rate_limit
      }

      tags = var.tags
    }

    resource "aws_cloudwatch_log_group" "api" {
      name              = "/aws/apigateway/${var.api_name}"
      retention_in_days = var.log_retention_days
      tags              = var.tags
    }
  modules/api_gateway/variables.tf: |
    variable "api_name" {
      type = string
    }

    variable "description" {
      type    = string
      default = ""
    }

    variable "stage_name" {
      type    = string
      default = "$default"
    }

    variable "auto_deploy" {
      type    = bool
      default = true
    }

    variable "cors_origins" {
      type    = list(string)
      default = ["*"]
    }

    variable "cors_methods" {
      type    = list(string)
      default = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    }

    variable "cors_headers" {
      type    = list(string)
      default = ["*"]
    }

    variable "cors_max_age" {
      type    = number
      default = 300
    }

    variable "cors_allow_credentials" {
      type    = bool
      default = false
    }

    variable "throttling_burst_limit" {
      type    = number
      default = 1000
    }

    variable "throttling_rate_limit" {
      type    = number
      default = 500
    }

    variable "log_retention_days" {
      type    = number
      default = 14
    }

    variable "tags" {
      type    = map(string)
      default = {}
    }
  handler.py: |
    def get_users(event, context):
        return {'statusCode': 200, 'body': '[]'}
  infrastructure/api.tf: |
    module "api" {
      source   = "./modules/api_gateway"
      api_name = "main-api"

      cors_origins = ["https://example.com"]
      cors_methods = ["GET", "POST"]

      tags = local.common_tags
    }

    resource "aws_apigatewayv2_route" "users" {
      api_id    = module.api.api_id
      route_key = "GET /users"
      target    = "integrations/${aws_apigatewayv2_integration.users.id}"
    }

    resource "aws_apigatewayv2_integration" "users" {
      api_id             = module.api.api_id
      integration_type   = "AWS_PROXY"
      integration_uri    = module.users_lambda.invoke_arn
      integration_method = "POST"
    }
  unrelated/glue.tf: |
    # GARBAGE_TF_GLUE_443_001
    resource "aws_glue_catalog_database" "unrelated_db" {
      name = "GARBAGE_GLUE_DB_443_002"
    }

    resource "aws_glue_crawler" "unrelated_crawler" {
      database_name = aws_glue_catalog_database.unrelated_db.name
      name          = "GARBAGE_CRAWLER_443_003"
      role          = "arn:aws:iam::123456789:role/GARBAGE_GLUE_ROLE_443_004"

      s3_target {
        path = "s3://GARBAGE_BUCKET_443_005/data/"
      }
    }
  unrelated/step_functions.tf: |
    # GARBAGE_TF_SFN_443_006
    resource "aws_sfn_state_machine" "unrelated_workflow" {
      name     = "GARBAGE_STATE_MACHINE_443_007"
      role_arn = "arn:aws:iam::123456789:role/GARBAGE_SFN_ROLE_443_008"

      definition = jsonencode({
        StartAt = "GARBAGE_STATE_443_009"
        States = {
          "GARBAGE_STATE_443_009" = {
            Type = "Pass"
            End  = true
          }
        }
      })
    }
changed:
  infrastructure/api.tf: |
    module "api" {
      source   = "./modules/api_gateway"
      api_name = "main-api"

      cors_origins = ["https://example.com", "https://app.example.com"]
      cors_methods = ["GET", "POST", "PUT", "DELETE"]

      throttling_burst_limit = 2000
      throttling_rate_limit  = 1000

      tags = local.common_tags
    }

    resource "aws_apigatewayv2_route" "users" {
      api_id    = module.api.api_id
      route_key = "GET /users"
      target    = "integrations/${aws_apigatewayv2_integration.users.id}"
    }

    resource "aws_apigatewayv2_route" "users_create" {
      api_id             = module.api.api_id
      route_key          = "POST /users"
      target             = "integrations/${aws_apigatewayv2_integration.users_create.id}"
      authorization_type = "JWT"
      authorizer_id      = aws_apigatewayv2_authorizer.jwt.id
    }

    resource "aws_apigatewayv2_route" "users_update" {
      api_id             = module.api.api_id
      route_key          = "PUT /users/{id}"
      target             = "integrations/${aws_apigatewayv2_integration.users_update.id}"
      authorization_type = "JWT"
      authorizer_id      = aws_apigatewayv2_authorizer.jwt.id
    }

    resource "aws_apigatewayv2_integration" "users" {
      api_id             = module.api.api_id
      integration_type   = "AWS_PROXY"
      integration_uri    = module.users_lambda.invoke_arn
      integration_method = "POST"
    }

    resource "aws_apigatewayv2_integration" "users_create" {
      api_id             = module.api.api_id
      integration_type   = "AWS_PROXY"
      integration_uri    = module.users_create_lambda.invoke_arn
      integration_method = "POST"
    }

    resource "aws_apigatewayv2_integration" "users_update" {
      api_id             = module.api.api_id
      integration_type   = "AWS_PROXY"
      integration_uri    = module.users_update_lambda.invoke_arn
      integration_method = "POST"
    }

    resource "aws_apigatewayv2_authorizer" "jwt" {
      api_id           = module.api.api_id
      authorizer_type  = "JWT"
      identity_sources = ["$request.header.Authorization"]
      name             = "jwt-authorizer"

      jwt_configuration {
        audience = [var.cognito_client_id]
        issuer   = "https://cognito-idp.${var.aws_region}.amazonaws.com/${var.cognito_user_pool_id}"
      }
    }
assertions:
  must_include:
    - aws_apigatewayv2_route
    - aws_apigatewayv2_api
    - aws_apigatewayv2_integration
    - aws_apigatewayv2_authorizer
    - cors_configuration
  must_not_include:
    - GARBAGE_TF_GLUE_443_001
    - GARBAGE_GLUE_DB_443_002
    - GARBAGE_CRAWLER_443_003
    - GARBAGE_GLUE_ROLE_443_004
    - GARBAGE_BUCKET_443_005
    - GARBAGE_TF_SFN_443_006
    - GARBAGE_STATE_MACHINE_443_007
    - GARBAGE_SFN_ROLE_443_008
    - GARBAGE_STATE_443_009
options:
  commit_message: Add new API Gateway routes with JWT authorization
