modules/s3/main.tf: |
  resource "aws_s3_bucket" "this" {
    bucket = var.bucket_name
    tags   = var.tags
  }

  resource "aws_s3_bucket_versioning" "this" {
    bucket = aws_s3_bucket.this.id
    versioning_configuration {
      status = var.versioning_enabled ? "Enabled" : "Disabled"
    }
  }

  resource "aws_s3_bucket_server_side_encryption_configuration" "this" {
    bucket = aws_s3_bucket.this.id

    rule {
      apply_server_side_encryption_by_default {
        sse_algorithm     = var.sse_algorithm
        kms_master_key_id = var.kms_key_id
      }
      bucket_key_enabled = var.bucket_key_enabled
    }
  }

  resource "aws_s3_bucket_public_access_block" "this" {
    bucket = aws_s3_bucket.this.id

    block_public_acls       = var.block_public_acls
    block_public_policy     = var.block_public_policy
    ignore_public_acls      = var.ignore_public_acls
    restrict_public_buckets = var.restrict_public_buckets
  }

  resource "aws_s3_bucket_lifecycle_configuration" "this" {
    count  = length(var.lifecycle_rules) > 0 ? 1 : 0
    bucket = aws_s3_bucket.this.id

    dynamic "rule" {
      for_each = var.lifecycle_rules
      content {
        id     = rule.value.id
        status = rule.value.enabled ? "Enabled" : "Disabled"

        filter {
          prefix = rule.value.prefix
        }

        dynamic "transition" {
          for_each = rule.value.transitions
          content {
            days          = transition.value.days
            storage_class = transition.value.storage_class
          }
        }

        dynamic "expiration" {
          for_each = rule.value.expiration_days != null ? [1] : []
          content {
            days = rule.value.expiration_days
          }
        }
      }
    }
  }
modules/s3/variables.tf: |
  variable "bucket_name" {
    type = string
  }

  variable "versioning_enabled" {
    type    = bool
    default = true
  }

  variable "sse_algorithm" {
    type    = string
    default = "aws:kms"
  }

  variable "kms_key_id" {
    type    = string
    default = null
  }

  variable "bucket_key_enabled" {
    type    = bool
    default = true
  }

  variable "block_public_acls" {
    type    = bool
    default = true
  }

  variable "block_public_policy" {
    type    = bool
    default = true
  }

  variable "ignore_public_acls" {
    type    = bool
    default = true
  }

  variable "restrict_public_buckets" {
    type    = bool
    default = true
  }

  variable "lifecycle_rules" {
    type    = list(any)
    default = []
  }

  variable "tags" {
    type    = map(string)
    default = {}
  }
modules/s3/outputs.tf: |
  output "bucket_id" {
    value = aws_s3_bucket.this.id
  }

  output "bucket_arn" {
    value = aws_s3_bucket.this.arn
  }

  output "bucket_domain_name" {
    value = aws_s3_bucket.this.bucket_domain_name
  }
app.py: |
  import boto3
  s3 = boto3.client('s3')
  s3.upload_file('file.txt', 'my-bucket', 'file.txt')
infrastructure/storage.tf: |
  module "data_bucket" {
    source      = "./modules/s3"
    bucket_name = "myapp-data-${var.environment}"

    tags = local.common_tags
  }
unrelated/emr.tf: |
  # GARBAGE_TF_EMR_444_001
  resource "aws_emr_cluster" "unrelated_cluster" {
    name          = "GARBAGE_EMR_CLUSTER_444_002"
    release_label = "emr-6.10.0"
    applications  = ["Spark", "Hadoop"]

    ec2_attributes {
      subnet_id        = "subnet-GARBAGE_444_003"
      instance_profile = "arn:aws:iam::123456789:instance-profile/GARBAGE_EMR_PROFILE_444_004"
    }

    master_instance_group {
      instance_type = "m5.xlarge"
    }

    core_instance_group {
      instance_type  = "m5.xlarge"
      instance_count = 2
    }

    service_role = "arn:aws:iam::123456789:role/GARBAGE_EMR_ROLE_444_005"
  }
unrelated/athena.tf: |
  # GARBAGE_TF_ATHENA_444_006
  resource "aws_athena_workgroup" "unrelated_workgroup" {
    name = "GARBAGE_ATHENA_WG_444_007"

    configuration {
      result_configuration {
        output_location = "s3://GARBAGE_ATHENA_BUCKET_444_008/results/"
      }
    }
  }

  resource "aws_athena_database" "unrelated_db" {
    name   = "GARBAGE_ATHENA_DB_444_009"
    bucket = "GARBAGE_ATHENA_BUCKET_444_008"
  }
