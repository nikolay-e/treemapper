name: tf_055_secrets_manager
initial:
  secrets.tf: |
    resource "aws_secretsmanager_secret" "db_creds" {
      name = "db-credentials"
    }
  src/secrets.py: |
    import boto3
    import json

    def get_secret(name: str) -> dict:
        sm = boto3.client("secretsmanager")
        response = sm.get_secret_value(SecretId=name)
        return json.loads(response["SecretString"])
changed:
  secrets.tf: |
    resource "aws_secretsmanager_secret" "db_creds" {
      name                    = "db-credentials"
      recovery_window_in_days = 0
    }

    resource "aws_secretsmanager_secret_rotation" "db_creds" {
      secret_id           = aws_secretsmanager_secret.db_creds.id
      rotation_lambda_arn = aws_lambda_function.rotate.arn
      rotation_rules {
        automatically_after_days = 30
      }
    }
assertions:
  must_include:
    - get_secret
options:
  commit_message: add rotation
