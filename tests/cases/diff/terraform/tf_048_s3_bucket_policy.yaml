name: tf_048_s3_bucket_policy
initial:
  s3.tf: |
    resource "aws_s3_bucket" "static" {
      bucket = "my-static-site"
    }

    resource "aws_s3_bucket_policy" "static" {
      bucket = aws_s3_bucket.static.id
      policy = jsonencode({
        Version = "2012-10-17"
        Statement = [{
          Effect    = "Allow"
          Principal = "*"
          Action    = ["s3:GetObject"]
          Resource  = "${aws_s3_bucket.static.arn}/*"
        }]
      })
    }
  src/upload.py: |
    import boto3

    def upload_file(bucket: str, key: str, data: bytes):
        s3 = boto3.client("s3")
        s3.put_object(Bucket=bucket, Key=key, Body=data)
changed:
  s3.tf: |
    resource "aws_s3_bucket" "static" {
      bucket = "my-static-site-prod"
    }

    resource "aws_s3_bucket_policy" "static" {
      bucket = aws_s3_bucket.static.id
      policy = jsonencode({
        Version = "2012-10-17"
        Statement = [{
          Effect    = "Allow"
          Principal = {"AWS": "arn:aws:iam::123456789:root"}
          Action    = ["s3:GetObject", "s3:PutObject"]
          Resource  = "${aws_s3_bucket.static.arn}/*"
        }]
      })
    }
assertions:
  must_include:
    - boto3
options:
  commit_message: update s3 policy
