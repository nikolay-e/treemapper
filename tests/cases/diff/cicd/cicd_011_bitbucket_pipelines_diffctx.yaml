must_include_files:
  - bitbucket-pipelines.yml
  - src/index.js
must_include_content:
  - |
    pipelines:
      default:
        - step:
            name: Build and Test
            caches:
              - node
            script:
              - npm ci
              - npm run build
              - npm test
      branches:
        main:
          - step:
              name: Deploy
              deployment: production
              script:
                - ./deploy.sh
  - |
    function main() {
      const app = createApp();
      const port = process.env.PORT || 3000;

      app.listen(port, () => {
        logger.info(`Server running on port ${port}`);
      });
    }
must_not_include:
  - GARBAGE_CICD_011_SOCKET_MARKER_A
  - GARBAGE_CICD_011_PORT_MARKER_B
  - GARBAGE_CICD_011_PROTOCOL_MARKER_C
  - GARBAGE_CICD_011_QUEUE_MARKER_D
  - GARBAGE_CICD_011_MAX_MARKER_E
  - GARBAGE_CICD_011_RETRY_MARKER_F
  - GarbageSocketServer
  - GarbageQueueManager
  - garbage_socket.js
  - garbage_queue.js
