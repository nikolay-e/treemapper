name: go_008_init_function
initial:
  internal/config/config.go: |
    package config

    import (
        "os"
        "strconv"
        "time"
    )

    var Config *AppConfig

    type AppConfig struct {
        Environment string
        Debug       bool
        Port        int
        Timeout     time.Duration
    }

    func init() {
        Config = &AppConfig{
            Environment: getEnv("APP_ENV", "development"),
            Debug:       getEnvBool("APP_DEBUG", false),
            Port:        getEnvInt("APP_PORT", 8080),
            Timeout:     getEnvDuration("APP_TIMEOUT", 30*time.Second),
        }
    }

    func getEnv(key, defaultVal string) string {
        if val := os.Getenv(key); val != "" {
            return val
        }
        return defaultVal
    }

    func getEnvBool(key string, defaultVal bool) bool {
        if val := os.Getenv(key); val != "" {
            b, _ := strconv.ParseBool(val)
            return b
        }
        return defaultVal
    }

    func getEnvInt(key string, defaultVal int) int {
        if val := os.Getenv(key); val != "" {
            i, _ := strconv.Atoi(val)
            return i
        }
        return defaultVal
    }

    func getEnvDuration(key string, defaultVal time.Duration) time.Duration {
        if val := os.Getenv(key); val != "" {
            d, _ := time.ParseDuration(val)
            return d
        }
        return defaultVal
    }

  cmd/main.go: |
    package main

    import (
        "fmt"
        "myproject/internal/config"
    )

    func main() {
        fmt.Printf("Starting in %s mode on port %d\n",
            config.Config.Environment,
            config.Config.Port)
    }

  internal/unrelated/bootstrap/initializer.go: |
    package bootstrap

    const GARBAGE_GO_BOOTSTRAP_INIT_001 = "bootstrap_garbage"

    type GARBAGE_GO_TYPE_BOOTSTRAP_002 struct {
        order int
    }

    func GARBAGE_GO_FUNC_BOOTSTRAP_003() string {
        return "GARBAGE_GO_BOOTSTRAP_UNUSED_004"
    }

  internal/unrelated/setup/database.go: |
    package setup

    const GARBAGE_GO_SETUP_DATABASE_005 = "setup_garbage"

    type GARBAGE_GO_TYPE_SETUP_006 struct {
        dsn string
    }

    func GARBAGE_GO_FUNC_SETUP_007() {
        println("GARBAGE_GO_SETUP_OUTPUT_008")
    }

changed:
  internal/config/config.go: |
    package config

    import (
        "log"
        "os"
        "strconv"
        "time"
    )

    var Config *AppConfig

    type AppConfig struct {
        Environment  string
        Debug        bool
        Port         int
        Timeout      time.Duration
        DatabaseURL  string
        RedisURL     string
        JWTSecret    string
        CORSOrigins  []string
        RateLimitRPS int
    }

    func init() {
        Config = &AppConfig{
            Environment:  getEnv("APP_ENV", "development"),
            Debug:        getEnvBool("APP_DEBUG", false),
            Port:         getEnvInt("APP_PORT", 8080),
            Timeout:      getEnvDuration("APP_TIMEOUT", 30*time.Second),
            DatabaseURL:  getEnvRequired("DATABASE_URL"),
            RedisURL:     getEnv("REDIS_URL", "redis://localhost:6379"),
            JWTSecret:    getEnvRequired("JWT_SECRET"),
            CORSOrigins:  getEnvSlice("CORS_ORIGINS", []string{"http://localhost:3000"}),
            RateLimitRPS: getEnvInt("RATE_LIMIT_RPS", 100),
        }

        validateConfig()
    }

    func validateConfig() {
        if Config.Port < 1 || Config.Port > 65535 {
            log.Fatal("Invalid port number")
        }
        if Config.Timeout < time.Second {
            log.Fatal("Timeout must be at least 1 second")
        }
    }

    func getEnv(key, defaultVal string) string {
        if val := os.Getenv(key); val != "" {
            return val
        }
        return defaultVal
    }

    func getEnvRequired(key string) string {
        val := os.Getenv(key)
        if val == "" && Config.Environment == "production" {
            log.Fatalf("Required environment variable %s not set", key)
        }
        return val
    }

    func getEnvBool(key string, defaultVal bool) bool {
        if val := os.Getenv(key); val != "" {
            b, _ := strconv.ParseBool(val)
            return b
        }
        return defaultVal
    }

    func getEnvInt(key string, defaultVal int) int {
        if val := os.Getenv(key); val != "" {
            i, _ := strconv.Atoi(val)
            return i
        }
        return defaultVal
    }

    func getEnvDuration(key string, defaultVal time.Duration) time.Duration {
        if val := os.Getenv(key); val != "" {
            d, _ := time.ParseDuration(val)
            return d
        }
        return defaultVal
    }

    func getEnvSlice(key string, defaultVal []string) []string {
        if val := os.Getenv(key); val != "" {
            return splitAndTrim(val, ",")
        }
        return defaultVal
    }

    func splitAndTrim(s, sep string) []string {
        parts := make([]string, 0)
        for _, p := range strings.Split(s, sep) {
            if trimmed := strings.TrimSpace(p); trimmed != "" {
                parts = append(parts, trimmed)
            }
        }
        return parts
    }

assertions:
  must_include:
    - Config
    - init
    - DatabaseURL
    - RedisURL
    - JWTSecret
    - CORSOrigins
    - RateLimitRPS
    - validateConfig
    - getEnvRequired
  must_not_include:
    - GARBAGE_GO_BOOTSTRAP_INIT_001
    - GARBAGE_GO_TYPE_BOOTSTRAP_002
    - GARBAGE_GO_FUNC_BOOTSTRAP_003
    - GARBAGE_GO_BOOTSTRAP_UNUSED_004
    - GARBAGE_GO_SETUP_DATABASE_005
    - GARBAGE_GO_TYPE_SETUP_006
    - GARBAGE_GO_FUNC_SETUP_007
    - GARBAGE_GO_SETUP_OUTPUT_008
    - bootstrap
    - setup
options:
  commit_message: Add database, redis, JWT config with validation
