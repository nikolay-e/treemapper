name: go_016_error_wrapping
initial:
  internal/errors/sentinel.go: |
    package errors

    import "errors"

    var (
        ErrNotFound   = errors.New("not found")
        ErrPermission = errors.New("permission denied")
        ErrInvalid    = errors.New("invalid input")
    )

  internal/repository/user_repository.go: |
    package repository

    import (
        "context"
        "database/sql"
    )

    type User struct {
        ID    int64
        Name  string
        Email string
    }

    type UserRepository struct {
        db *sql.DB
    }

    func NewUserRepository(db *sql.DB) *UserRepository {
        return &UserRepository{db: db}
    }

    func (r *UserRepository) FindByID(ctx context.Context, id int64) (*User, error) {
        row := r.db.QueryRowContext(ctx, "SELECT id, name, email FROM users WHERE id = ?", id)
        var user User
        if err := row.Scan(&user.ID, &user.Name, &user.Email); err != nil {
            return nil, err
        }
        return &user, nil
    }

  internal/service/user_service.go: |
    package service

    import (
        "context"
        "myproject/internal/repository"
    )

    type UserService struct {
        repo *repository.UserRepository
    }

    func NewUserService(repo *repository.UserRepository) *UserService {
        return &UserService{repo: repo}
    }

    func (s *UserService) GetUser(ctx context.Context, id int64) (*repository.User, error) {
        return s.repo.FindByID(ctx, id)
    }

  internal/unrelated/logging/formatter.go: |
    package logging

    const GARBAGE_GO_LOG_FORMATTER_001 = "logging_garbage"

    type GARBAGE_GO_TYPE_FORMATTER_002 struct {
        pattern string
    }

    func GARBAGE_GO_FUNC_FORMATTER_003() string {
        return "GARBAGE_GO_FORMATTER_UNUSED_004"
    }

  internal/unrelated/logging/writer.go: |
    package logging

    const GARBAGE_GO_LOG_WRITER_005 = "writer_garbage"

    type GARBAGE_GO_TYPE_WRITER_006 struct {
        output string
    }

    func GARBAGE_GO_FUNC_WRITER_007() {
        println("GARBAGE_GO_WRITER_OUTPUT_008")
    }

changed:
  internal/service/user_service.go: |
    package service

    import (
        "context"
        "database/sql"
        "errors"
        "fmt"
        apperrors "myproject/internal/errors"
        "myproject/internal/repository"
    )

    type UserService struct {
        repo *repository.UserRepository
    }

    func NewUserService(repo *repository.UserRepository) *UserService {
        return &UserService{repo: repo}
    }

    func (s *UserService) GetUser(ctx context.Context, id int64) (*repository.User, error) {
        user, err := s.repo.FindByID(ctx, id)
        if err != nil {
            if errors.Is(err, sql.ErrNoRows) {
                return nil, fmt.Errorf("GetUser(%d): %w", id, apperrors.ErrNotFound)
            }
            return nil, fmt.Errorf("GetUser(%d): repository error: %w", id, err)
        }
        return user, nil
    }

    func (s *UserService) GetUserOrDefault(ctx context.Context, id int64) *repository.User {
        user, err := s.GetUser(ctx, id)
        if err != nil {
            if errors.Is(err, apperrors.ErrNotFound) {
                return &repository.User{Name: "Guest", Email: "guest@example.com"}
            }
            return nil
        }
        return user
    }

    func (s *UserService) UpdateUser(ctx context.Context, id int64, name, email string) error {
        user, err := s.GetUser(ctx, id)
        if err != nil {
            return fmt.Errorf("UpdateUser: %w", err)
        }
        user.Name = name
        user.Email = email
        if err := s.repo.Update(ctx, user); err != nil {
            return fmt.Errorf("UpdateUser: failed to update: %w", err)
        }
        return nil
    }

    func (s *UserService) DeleteUser(ctx context.Context, id int64) error {
        if _, err := s.GetUser(ctx, id); err != nil {
            return fmt.Errorf("DeleteUser: %w", err)
        }
        if err := s.repo.Delete(ctx, id); err != nil {
            return fmt.Errorf("DeleteUser: failed to delete: %w", err)
        }
        return nil
    }

assertions:
  must_include:
    - GetUser
    - GetUserOrDefault
    - UpdateUser
    - DeleteUser
    - Errorf
    - errors.Is
    - "%w"
  must_not_include:
    - GARBAGE_GO_LOG_FORMATTER_001
    - GARBAGE_GO_TYPE_FORMATTER_002
    - GARBAGE_GO_FUNC_FORMATTER_003
    - GARBAGE_GO_FORMATTER_UNUSED_004
    - GARBAGE_GO_LOG_WRITER_005
    - GARBAGE_GO_TYPE_WRITER_006
    - GARBAGE_GO_FUNC_WRITER_007
    - GARBAGE_GO_WRITER_OUTPUT_008
    - formatter
    - writer.go
options:
  commit_message: Add error wrapping to user service methods
