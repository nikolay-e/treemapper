name: go_018_function_type
initial:
  internal/http/types.go: |
    package http

    type Request struct {
        Path    string
        Method  string
        Headers map[string]string
        Body    []byte
    }

    type Response struct {
        Status  int
        Headers map[string]string
        Body    []byte
    }

    type Handler func(req Request) Response
    type Middleware func(Handler) Handler

  internal/http/router.go: |
    package http

    type Router struct {
        handlers map[string]Handler
    }

    func NewRouter() *Router {
        return &Router{
            handlers: make(map[string]Handler),
        }
    }

    func (r *Router) Handle(path string, handler Handler) {
        r.handlers[path] = handler
    }

  internal/unrelated/grpc/interceptor.go: |
    package grpc

    const GARBAGE_GO_GRPC_INTERCEPT_001 = "grpc_garbage"

    type GARBAGE_GO_TYPE_INTERCEPT_002 struct {
        timeout int
    }

    func GARBAGE_GO_FUNC_INTERCEPT_003() string {
        return "GARBAGE_GO_INTERCEPT_UNUSED_004"
    }

  internal/unrelated/grpc/codec.go: |
    package grpc

    const GARBAGE_GO_GRPC_CODEC_005 = "codec_garbage"

    type GARBAGE_GO_TYPE_CODEC_006 struct {
        encoding string
    }

    func GARBAGE_GO_FUNC_CODEC_007() {
        println("GARBAGE_GO_CODEC_OUTPUT_008")
    }

changed:
  internal/http/router.go: |
    package http

    import (
        "log"
        "time"
    )

    type Router struct {
        handlers    map[string]Handler
        middlewares []Middleware
        logger      *log.Logger
    }

    func NewRouter(logger *log.Logger) *Router {
        return &Router{
            handlers: make(map[string]Handler),
            logger:   logger,
        }
    }

    func (r *Router) Use(m Middleware) {
        r.middlewares = append(r.middlewares, m)
    }

    func (r *Router) Handle(path string, handler Handler) {
        wrapped := r.applyMiddlewares(handler)
        r.handlers[path] = wrapped
    }

    func (r *Router) applyMiddlewares(h Handler) Handler {
        for i := len(r.middlewares) - 1; i >= 0; i-- {
            h = r.middlewares[i](h)
        }
        return h
    }

    func (r *Router) ServeHTTP(req Request) Response {
        handler, ok := r.handlers[req.Path]
        if !ok {
            return Response{Status: 404, Body: []byte("Not Found")}
        }
        return handler(req)
    }

    func LoggingMiddleware(logger *log.Logger) Middleware {
        return func(next Handler) Handler {
            return func(req Request) Response {
                start := time.Now()
                resp := next(req)
                logger.Printf("%s %s - %d (%v)", req.Method, req.Path, resp.Status, time.Since(start))
                return resp
            }
        }
    }

    func RecoveryMiddleware(logger *log.Logger) Middleware {
        return func(next Handler) Handler {
            return func(req Request) (resp Response) {
                defer func() {
                    if r := recover(); r != nil {
                        logger.Printf("Panic recovered: %v", r)
                        resp = Response{Status: 500, Body: []byte("Internal Server Error")}
                    }
                }()
                return next(req)
            }
        }
    }

    func AuthMiddleware(validateToken func(string) bool) Middleware {
        return func(next Handler) Handler {
            return func(req Request) Response {
                token := req.Headers["Authorization"]
                if token == "" || !validateToken(token) {
                    return Response{Status: 401, Body: []byte("Unauthorized")}
                }
                return next(req)
            }
        }
    }

assertions:
  must_include:
    - Router
    - Use
    - Handle
    - Middleware
    - LoggingMiddleware
    - RecoveryMiddleware
    - AuthMiddleware
    - applyMiddlewares
  must_not_include:
    - GARBAGE_GO_GRPC_INTERCEPT_001
    - GARBAGE_GO_TYPE_INTERCEPT_002
    - GARBAGE_GO_FUNC_INTERCEPT_003
    - GARBAGE_GO_INTERCEPT_UNUSED_004
    - GARBAGE_GO_GRPC_CODEC_005
    - GARBAGE_GO_TYPE_CODEC_006
    - GARBAGE_GO_FUNC_CODEC_007
    - GARBAGE_GO_CODEC_OUTPUT_008
    - interceptor
    - codec.go
options:
  commit_message: Add middleware support with logging, recovery, and auth
